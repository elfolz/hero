(self.webpackChunkhero=self.webpackChunkhero||[]).push([[19],{934:(e,t,n)=>{n.d(t,{Z:()=>r});const r={get name(){return/(iphone)/i.test(navigator.userAgent)?"iphone":/(ipad)/i.test(navigator.userAgent)?"ipad":/(android)/i.test(navigator.userAgent)?"android":/(windows)/i.test(navigator.userAgent)?"windows":/(linux|arch|ubuntu|mint|manjaro|debian)/i.test(navigator.userAgent)?"linux":/(mac|macos|macintosh)/i.test(navigator.userAgent)?"mac":null},get osVersion(){return/(iphone)/i.test(navigator.userAgent)?parseInt(/OS\s(\d+)_(\d+)_?(\d+)?/i.exec(navigator.userAgent)[1]||"0"):parseInt(/(?:linux|arch|ubuntu|mint|manjaro|debian|windows|android|mac)\s([\.\_\d]+)/i.exec(navigator.userAgent)[1]||"0")},get memory(){return navigator.deviceMemory??0},get cpuCores(){return navigator.hardwareConcurrency??0},get isMobile(){return/(iphone|ipad|android)/i.test(navigator.userAgent)},get isPC(){return!/(iphone|ipad|android)/i.test(navigator.userAgent)},get isApple(){return/(iphone|ipad|mac)/i.test(navigator.userAgent)},get isLocalhost(){return["127.0.0.1","localhost"].includes(location.hostname)}}},815:(e,t,n)=>{function r(e,t,n=!0){let r=Math.random()*(t-e+1)+e;return n?Math.floor(r):r}n.d(t,{Z:()=>r})},194:(e,t,n)=>{var r,o=n(934);function s(){document.hidden||"wakeLock"in navigator&&navigator.wakeLock.request("screen").then((e=>r=e))}window.menuConfigOpened=function(){return document.querySelector("#menu-config").classList.contains("opened")},window.toggleMenuConfig=function(e=!1){const t=document.querySelector("#menu-config");t.classList.toggle("opened"),t.classList.contains("opened")?window.sound.playClick():window.sound.playCancel(),e&&t.classList.contains("opened")?t.firstChild.classList.add("active"):t.childNodes.forEach((e=>e.classList.remove("active")))},window.navigateMenuConfig=function(e){const t=Array.from(document.querySelector("#menu-config").childNodes).filter((e=>!e.classList.contains("off"))),n=t.findIndex((e=>e.classList.contains("active")));let r;e>0&&n<t.length-1?r=n+1:e<0&&n>0&&(r=n-1),r>=0&&(window.sound.playCursor(),document.querySelector("#menu-config").childNodes.forEach((e=>e.classList.remove("active"))),t[r].classList.add("active"))},window.executeMenuConfig=function(e){if(e||(e=Array.from(document.querySelector("#menu-config").childNodes).find((e=>e.classList.contains("active"))).id),e.includes("music-on"))localStorage.setItem("bgm","true"),document.querySelector("#menu-button-music-on").classList.add("off"),document.querySelector("#menu-button-music-off").classList.remove("off"),document.querySelector("#menu-config").childNodes.forEach((e=>e.classList.remove("active"))),document.querySelector("#menu-config").childNodes[1].classList.add("active"),window.sound.playBGM();else if(e.includes("music-off"))localStorage.setItem("bgm","false"),document.querySelector("#menu-button-music-off").classList.add("off"),document.querySelector("#menu-button-music-on").classList.remove("off"),document.querySelector("#menu-config").childNodes.forEach((e=>e.classList.remove("active"))),document.querySelector("#menu-config").childNodes[0].classList.add("active"),window.sound.stopBGM();else if(e.includes("controls")){let e=document.querySelector("#dialog-controller");e.classList.toggle("opened"),e.classList.contains("opened")?window.sound.playClick():window.sound.playCancel()}else e.includes("fps")?(localStorage.getItem("fpsLimit")&&"0"!=localStorage.getItem("fpsLimit")?"60"==localStorage.getItem("fpsLimit")?window.refreshFPS(30):"30"==localStorage.getItem("fpsLimit")&&window.refreshFPS(0):window.refreshFPS(60),window.game.refreshFPS(!1)):e.includes("resolution")?(localStorage.getItem("resolution")&&"0"!=localStorage.getItem("resolution")?"1"==localStorage.getItem("resolution")?window.refreshResolution(2):"2"==localStorage.getItem("resolution")&&window.refreshResolution(0):window.refreshResolution(1),window.game.refreshResolution(!1),window.game.resizeScene()):e.includes("pixel_density")?(localStorage.getItem("pixelDensity")&&"0"!=localStorage.getItem("pixelDensity")?"1"==localStorage.getItem("pixelDensity")?window.refreshPixelDensity(2):"2"==localStorage.getItem("pixelDensity")&&window.refreshPixelDensity(0):window.refreshPixelDensity(1),window.game.refreshPixelDensity(),window.game.resizeScene()):e.includes("antialiasing")?("true"==localStorage.getItem("antialiasing")?window.refreshAntialiasing(!1):window.refreshAntialiasing(!0),window.game.refreshAntialiasing(!1)):e.includes("force_refresh")&&caches.delete("hero").then((()=>location.reload(!0)))},window.refreshFPS=function(e,t=!0){t&&("number"==typeof e?localStorage.setItem("fpsLimit",e.toString()):localStorage.removeItem("fpsLimit")),document.querySelector("#menu-button-fps label").innerHTML=`${e>0?e:"Auto"} FPS`},window.refreshResolution=function(e,t=!0){t&&("number"==typeof e?localStorage.setItem("resolution",e):localStorage.removeItem("resolution"));let n=(1==e?"Média":2==e?"Baixa":"Alta")+" resolução";document.querySelector("#menu-button-resolution label").innerHTML=n},window.refreshPixelDensity=function(e,t=!0){t&&("number"==typeof e?localStorage.setItem("pixelDensity",e.toString()):localStorage.removeItem("pixelDensity"));let n=(1==e?"Média":2==e?"Baixa":"Alta")+" densidade de pixels";document.querySelector("#menu-button-pixel_density label").innerHTML=n},window.refreshAntialiasing=function(e,t=!0){t&&("boolean"==typeof e?localStorage.setItem("antialiasing",e.toString()):localStorage.removeItem("antialiasing"));let n="Antialiasing "+(e?"ligado":"desligado");document.querySelector("#menu-button-antialiasing label").innerHTML=n,e?(document.querySelector("#antialiasing-on").style.removeProperty("display"),document.querySelector("#antialiasing-off").style.setProperty("display","none")):(document.querySelector("#antialiasing-on").style.setProperty("display","none"),document.querySelector("#antialiasing-off").style.removeProperty("display"))},window.refreshControlsMenu=()=>{window.game?.player?.gamepadConnected||o.Z.isPC?document.querySelector("#menu-button-controls").style.removeProperty("display"):document.querySelector("#menu-button-controls").style.setProperty("display","none"),window.game?.player?.gamepadConnected?(document.querySelectorAll("#gamepad")?.forEach((e=>e.style.removeProperty("display"))),document.querySelectorAll("#keyboard")?.forEach((e=>e.style.setProperty("display","none")))):(document.querySelectorAll("#gamepad")?.forEach((e=>e.style.setProperty("display","none"))),document.querySelectorAll("#keyboard")?.forEach((e=>e.style.removeProperty("display"))))},document.onclick=()=>{document.querySelector("#menu-config").classList.remove("opened"),window.sound.initialized||window.sound.init()},document.onvisibilitychange=()=>{window.game?.toggleVisibility(),window.sound?.toggleVisibility(),document.hidden?(document.querySelectorAll("footer section button").forEach((e=>{e.classList.remove("active")})),r&&r.release()):s()},document.onreadystatechange=()=>{"complete"==document.readyState&&("false"==localStorage.getItem("bgm")&&(document.querySelector("#menu-button-music-on").classList.remove("off"),document.querySelector("#menu-button-music-off").classList.add("off")),document.querySelector("#button-config").onclick=e=>{e.stopPropagation(),window.toggleMenuConfig()},document.querySelector("#menu-button-music-off").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("music-off")},document.querySelector("#menu-button-music-on").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("music-on")},document.querySelector("#menu-button-controls").onclick=e=>{window.executeMenuConfig("controls")},document.querySelector("#dialog-controller button").onclick=e=>{document.querySelector("#dialog-controller").classList.remove("opened")},document.querySelector("#menu-button-fps").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("fps")},document.querySelector("#menu-button-resolution").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("resolution")},document.querySelector("#menu-button-pixel_density").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("pixel_density")},document.querySelector("#menu-button-antialiasing").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("antialiasing")},document.querySelector("#menu-button-force_refresh").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("force_refresh")},window.refreshControlsMenu())},window.oncontextmenu=e=>(e.preventDefault(),!1),"screen"in window&&(screen.orientation.onchange=()=>{window.game?.refreshResolution(),window.game?.resizeScene()}),s();var i=n(354),a=n(598);if(window.sound=new i.$,window.game=new a.l,location.protocol.startsWith("https")){var l=!1;navigator.serviceWorker.register("service-worker.js").then((e=>{e.onupdatefound=()=>{console.info("SW update found."),l=!0},e.installing?console.info("SW installing..."):e.active&&l&&(console.info("SW updated. Reloading..."),location.reload())}))}},271:(e,t,n)=>{n.d(t,{Vs:()=>o});var r=n(479);function o(e,t){if(t===r.WwZ)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===r.z$h||t===r.UlW){let n=e.getIndex();if(null===n){const t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const o=n.count-2,s=[];if(t===r.z$h)for(let e=1;e<=o;e++)s.push(n.getX(0)),s.push(n.getX(e)),s.push(n.getX(e+1));else for(let e=0;e<o;e++)e%2==0?(s.push(n.getX(e)),s.push(n.getX(e+1)),s.push(n.getX(e+2))):(s.push(n.getX(e+2)),s.push(n.getX(e+1)),s.push(n.getX(e)));s.length/3!==o&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=e.clone();return i.setIndex(s),i.clearGroups(),i}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}},944:(e,t,n)=>{n.d(t,{k:()=>o});var r=n(479);class o extends r.u9r{constructor(e,t,n,o){super();const i=[],a=[],l=[],c=new r.Pa4,u=new r.yGw;u.makeRotationFromEuler(n),u.setPosition(t);const p=new r.yGw;function d(t,n,r){n.applyMatrix4(e.matrixWorld),n.applyMatrix4(p),r.transformDirection(e.matrixWorld),t.push(new s(n.clone(),r.clone()))}function h(e,t){const n=[],r=.5*Math.abs(o.dot(t));for(let o=0;o<e.length;o+=3){let s,i,a,l,c=0;const u=e[o+0].position.dot(t)-r>0,p=e[o+1].position.dot(t)-r>0,d=e[o+2].position.dot(t)-r>0;switch(c=(u?1:0)+(p?1:0)+(d?1:0),c){case 0:n.push(e[o]),n.push(e[o+1]),n.push(e[o+2]);break;case 1:if(u&&(s=e[o+1],i=e[o+2],a=m(e[o],s,t,r),l=m(e[o],i,t,r)),p){s=e[o],i=e[o+2],a=m(e[o+1],s,t,r),l=m(e[o+1],i,t,r),n.push(a),n.push(i.clone()),n.push(s.clone()),n.push(i.clone()),n.push(a.clone()),n.push(l);break}d&&(s=e[o],i=e[o+1],a=m(e[o+2],s,t,r),l=m(e[o+2],i,t,r)),n.push(s.clone()),n.push(i.clone()),n.push(a),n.push(l),n.push(a.clone()),n.push(i.clone());break;case 2:u||(s=e[o].clone(),i=m(s,e[o+1],t,r),a=m(s,e[o+2],t,r),n.push(s),n.push(i),n.push(a)),p||(s=e[o+1].clone(),i=m(s,e[o+2],t,r),a=m(s,e[o],t,r),n.push(s),n.push(i),n.push(a)),d||(s=e[o+2].clone(),i=m(s,e[o],t,r),a=m(s,e[o+1],t,r),n.push(s),n.push(i),n.push(a))}}return n}function m(e,t,n,o){const i=e.position.dot(n)-o,a=i/(i-(t.position.dot(n)-o));return new s(new r.Pa4(e.position.x+a*(t.position.x-e.position.x),e.position.y+a*(t.position.y-e.position.y),e.position.z+a*(t.position.z-e.position.z)),new r.Pa4(e.normal.x+a*(t.normal.x-e.normal.x),e.normal.y+a*(t.normal.y-e.normal.y),e.normal.z+a*(t.normal.z-e.normal.z)))}p.copy(u).invert(),function(){let t=[];const n=new r.Pa4,s=new r.Pa4,p=e.geometry,m=p.attributes.position,f=p.attributes.normal;if(null!==p.index){const e=p.index;for(let r=0;r<e.count;r++)n.fromBufferAttribute(m,e.getX(r)),s.fromBufferAttribute(f,e.getX(r)),d(t,n,s)}else for(let e=0;e<m.count;e++)n.fromBufferAttribute(m,e),s.fromBufferAttribute(f,e),d(t,n,s);t=h(t,c.set(1,0,0)),t=h(t,c.set(-1,0,0)),t=h(t,c.set(0,1,0)),t=h(t,c.set(0,-1,0)),t=h(t,c.set(0,0,1)),t=h(t,c.set(0,0,-1));for(let e=0;e<t.length;e++){const n=t[e];l.push(.5+n.position.x/o.x,.5+n.position.y/o.y),n.position.applyMatrix4(u),i.push(n.position.x,n.position.y,n.position.z),a.push(n.normal.x,n.normal.y,n.normal.z)}}(),this.setAttribute("position",new r.a$l(i,3)),this.setAttribute("normal",new r.a$l(a,3)),this.setAttribute("uv",new r.a$l(l,2))}}class s{constructor(e,t){this.position=e,this.normal=t}clone(){return new this.constructor(this.position.clone(),this.normal.clone())}}},527:(e,t,n)=>{n.d(t,{y:()=>c});var r=n(479),o=n(464),s=n(702);let i,a,l;class c extends r.aNw{constructor(e){super(e)}load(e,t,n,o){const s=this,i=""===s.path?r.Zp0.extractUrlBase(e):s.path,a=new r.hH6(this.manager);a.setPath(s.path),a.setResponseType("arraybuffer"),a.setRequestHeader(s.requestHeader),a.setWithCredentials(s.withCredentials),a.load(e,(function(n){try{t(s.parse(n,i))}catch(t){o?o(t):console.error(t),s.manager.itemError(e)}}),n,o)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===P(e,0,t.length)}(e))i=(new m).parse(e);else{const t=P(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function r(t){const r=e[t-1];return e=e.slice(n+t),n++,r}for(let e=0;e<t.length;++e){if(r(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(y(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+y(t));i=(new h).parse(t)}const n=new r.dpR(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new u(n,this.manager).parse(i)}}class u{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){a=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),r=this.parseDeformers(),o=(new p).parse(r);return this.parseScene(r,o,n),l}parseConnections(){const e=new Map;if("Connections"in i){i.Connections.connections.forEach((function(t){const n=t[0],r=t[1],o=t[2];e.has(n)||e.set(n,{parents:[],children:[]});const s={ID:r,relationship:o};e.get(n).parents.push(s),e.has(r)||e.set(r,{parents:[],children:[]});const i={ID:n,relationship:o};e.get(r).children.push(i)}))}return e}parseImages(){const e={},t={};if("Video"in i.Objects){const n=i.Objects.Video;for(const r in n){const o=n[r];if(e[parseInt(r)]=o.RelativeFilename||o.Filename,"Content"in o){const e=o.Content instanceof ArrayBuffer&&o.Content.byteLength>0,s="string"==typeof o.Content&&""!==o.Content;if(e||s){const e=this.parseImage(n[r]);t[o.RelativeFilename||o.Filename]=e}}}}for(const n in e){const r=e[n];void 0!==t[r]?e[n]=t[r]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,r=n.slice(n.lastIndexOf(".")+1).toLowerCase();let o;switch(r){case"bmp":o="image/bmp";break;case"jpg":case"jpeg":o="image/jpeg";break;case"png":o="image/png";break;case"tif":o="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",n),o="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+r+'" is not supported.')}if("string"==typeof t)return"data:"+o+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:o}))}}parseTextures(e){const t=new Map;if("Texture"in i.Objects){const n=i.Objects.Texture;for(const r in n){const o=this.parseTexture(n[r],e);t.set(parseInt(r),o)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const o=e.WrapModeU,s=e.WrapModeV,i=void 0!==o?o.value:0,a=void 0!==s?s.value:0;if(n.wrapS=0===i?r.rpg:r.uWy,n.wrapT=0===a?r.rpg:r.uWy,"Scaling"in e){const t=e.Scaling.value;n.repeat.x=t[0],n.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;n.offset.x=t[0],n.offset.y=t[1]}return n}loadTexture(e,t){let n;const o=this.textureLoader.path,s=a.get(e.id).children;let i;void 0!==s&&s.length>0&&void 0!==t[s[0].ID]&&(n=t[s[0].ID],0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));const l=e.FileName.slice(-3).toLowerCase();if("tga"===l){const t=this.manager.getHandler(".tga");null===t?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),i=new r.xEZ):(t.setPath(this.textureLoader.path),i=t.load(n))}else"psd"===l?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),i=new r.xEZ):i=this.textureLoader.load(n);return this.textureLoader.setPath(o),i}parseMaterials(e){const t=new Map;if("Material"in i.Objects){const n=i.Objects.Material;for(const r in n){const o=this.parseMaterial(n[r],e);null!==o&&t.set(parseInt(r),o)}}return t}parseMaterial(e,t){const n=e.id,o=e.attrName;let s=e.ShadingModel;if("object"==typeof s&&(s=s.value),!a.has(n))return null;const i=this.parseParameters(e,t,n);let l;switch(s.toLowerCase()){case"phong":l=new r.xoR;break;case"lambert":l=new r.YBo;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',s),l=new r.xoR}return l.setValues(i),l.name=o,l}parseParameters(e,t,n){const o={};e.BumpFactor&&(o.bumpScale=e.BumpFactor.value),e.Diffuse?o.color=(new r.Ilk).fromArray(e.Diffuse.value).convertSRGBToLinear():!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(o.color=(new r.Ilk).fromArray(e.DiffuseColor.value).convertSRGBToLinear()),e.DisplacementFactor&&(o.displacementScale=e.DisplacementFactor.value),e.Emissive?o.emissive=(new r.Ilk).fromArray(e.Emissive.value).convertSRGBToLinear():!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(o.emissive=(new r.Ilk).fromArray(e.EmissiveColor.value).convertSRGBToLinear()),e.EmissiveFactor&&(o.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(o.opacity=parseFloat(e.Opacity.value)),o.opacity<1&&(o.transparent=!0),e.ReflectionFactor&&(o.reflectivity=e.ReflectionFactor.value),e.Shininess&&(o.shininess=e.Shininess.value),e.Specular?o.specular=(new r.Ilk).fromArray(e.Specular.value).convertSRGBToLinear():e.SpecularColor&&"Color"===e.SpecularColor.type&&(o.specular=(new r.Ilk).fromArray(e.SpecularColor.value).convertSRGBToLinear());const s=this;return a.get(n).children.forEach((function(e){const n=e.relationship;switch(n){case"Bump":o.bumpMap=s.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":o.aoMap=s.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":o.map=s.getTexture(t,e.ID),void 0!==o.map&&(o.map.colorSpace=r.KI_);break;case"DisplacementColor":o.displacementMap=s.getTexture(t,e.ID);break;case"EmissiveColor":o.emissiveMap=s.getTexture(t,e.ID),void 0!==o.emissiveMap&&(o.emissiveMap.colorSpace=r.KI_);break;case"NormalMap":case"Maya|TEX_normal_map":o.normalMap=s.getTexture(t,e.ID);break;case"ReflectionColor":o.envMap=s.getTexture(t,e.ID),void 0!==o.envMap&&(o.envMap.mapping=r.dSO,o.envMap.colorSpace=r.KI_);break;case"SpecularColor":o.specularMap=s.getTexture(t,e.ID),void 0!==o.specularMap&&(o.specularMap.colorSpace=r.KI_);break;case"TransparentColor":case"TransparencyFactor":o.alphaMap=s.getTexture(t,e.ID),o.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",n)}})),o}getTexture(e,t){return"LayeredTexture"in i.Objects&&t in i.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=a.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in i.Objects){const n=i.Objects.Deformer;for(const r in n){const o=n[r],s=a.get(parseInt(r));if("Skin"===o.attrType){const t=this.parseSkeleton(s,n);t.ID=r,s.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=s.parents[0].ID,e[r]=t}else if("BlendShape"===o.attrType){const e={id:r};e.rawTargets=this.parseMorphTargets(s,n),e.id=r,s.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[r]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach((function(e){const o=t[e.ID];if("Cluster"!==o.attrType)return;const s={ID:e.ID,indices:[],weights:[],transformLink:(new r.yGw).fromArray(o.TransformLink.a)};"Indexes"in o&&(s.indices=o.Indexes.a,s.weights=o.Weights.a),n.push(s)})),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let r=0;r<e.children.length;r++){const o=e.children[r],s=t[o.ID],i={name:s.attrName,initialWeight:s.DeformPercent,id:s.id,fullWeights:s.FullWeights.a};if("BlendShapeChannel"!==s.attrType)return;i.geoID=a.get(parseInt(o.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(i)}return n}parseScene(e,t,n){l=new r.ZAu;const o=this.parseModels(e.skeletons,t,n),s=i.Objects.Model,c=this;o.forEach((function(e){const t=s[e.ID];c.setLookAtProperties(e,t);a.get(e.ID).parents.forEach((function(t){const n=o.get(t.ID);void 0!==n&&n.add(e)})),null===e.parent&&l.add(e)})),this.bindSkeleton(e.skeletons,t,o),this.createAmbientLight(),l.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=T(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const u=(new d).parse();1===l.children.length&&l.children[0].isGroup&&(l.children[0].animations=u,l=l.children[0]),l.animations=u}parseModels(e,t,n){const o=new Map,s=i.Objects.Model;for(const i in s){const l=parseInt(i),c=s[i],u=a.get(l);let p=this.buildSkeleton(u,e,l,c.attrName);if(!p){switch(c.attrType){case"Camera":p=this.createCamera(u);break;case"Light":p=this.createLight(u);break;case"Mesh":p=this.createMesh(u,t,n);break;case"NurbsCurve":p=this.createCurve(u,t);break;case"LimbNode":case"Root":p=new r.N$j;break;default:p=new r.ZAu}p.name=c.attrName?r.iUV.sanitizeNodeName(c.attrName):"",p.ID=l}this.getTransformData(p,c),o.set(l,p)}return o}buildSkeleton(e,t,n,o){let s=null;return e.parents.forEach((function(e){for(const i in t){const a=t[i];a.rawBones.forEach((function(t,i){if(t.ID===e.ID){const e=s;s=new r.N$j,s.matrixWorld.copy(t.transformLink),s.name=o?r.iUV.sanitizeNodeName(o):"",s.ID=n,a.bones[i]=s,null!==e&&s.add(e)}}))}})),s}createCamera(e){let t,n;if(e.children.forEach((function(e){const t=i.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new r.Tme;else{let e=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(e=1);let o=1;void 0!==n.NearPlane&&(o=n.NearPlane.value/1e3);let s=1e3;void 0!==n.FarPlane&&(s=n.FarPlane.value/1e3);let i=window.innerWidth,a=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(i=n.AspectWidth.value,a=n.AspectHeight.value);const l=i/a;let c=45;void 0!==n.FieldOfView&&(c=n.FieldOfView.value);const u=n.FocalLength?n.FocalLength.value:null;switch(e){case 0:t=new r.cPb(c,l,o,s),null!==u&&t.setFocalLength(u);break;case 1:t=new r.iKG(-i/2,i/2,a/2,-a/2,o,s);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new r.Tme}}return t}createLight(e){let t,n;if(e.children.forEach((function(e){const t=i.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new r.Tme;else{let e;e=void 0===n.LightType?0:n.LightType.value;let o=16777215;void 0!==n.Color&&(o=(new r.Ilk).fromArray(n.Color.value).convertSRGBToLinear());let s=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(s=0);let i=0;void 0!==n.FarAttenuationEnd&&(i=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);const a=1;switch(e){case 0:t=new r.cek(o,s,i,a);break;case 1:t=new r.Ox3(o,s);break;case 2:let e=Math.PI/3;void 0!==n.InnerAngle&&(e=r.M8C.degToRad(n.InnerAngle.value));let l=0;void 0!==n.OuterAngle&&(l=r.M8C.degToRad(n.OuterAngle.value),l=Math.max(l,1)),t=new r.PMe(o,s,i,e,l,a);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new r.cek(o,s)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,n){let o,s=null,i=null;const a=[];return e.children.forEach((function(e){t.has(e.ID)&&(s=t.get(e.ID)),n.has(e.ID)&&a.push(n.get(e.ID))})),a.length>1?i=a:a.length>0?i=a[0]:(i=new r.xoR({color:13421772}),a.push(i)),"color"in s.attributes&&a.forEach((function(e){e.vertexColors=!0})),s.FBX_Deformer?(o=new r.TUv(s,i),o.normalizeSkinWeights()):o=new r.Kj0(s,i),o}createCurve(e,t){const n=e.children.reduce((function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e}),null),o=new r.nls({color:3342591,linewidth:1});return new r.x12(n,o)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder="RotationOrder"in t?S(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){if("LookAtProperty"in t){a.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const n=i.Objects.Model[t.ID];if("Lcl_Translation"in n){const t=n.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),l.add(e.target)):e.lookAt((new r.Pa4).fromArray(t))}}}))}}bindSkeleton(e,t,n){const o=this.parsePoseNodes();for(const s in e){const i=e[s];a.get(parseInt(i.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;a.get(t).parents.forEach((function(e){if(n.has(e.ID)){n.get(e.ID).bind(new r.OdW(i.bones),o[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in i.Objects){const t=i.Objects.Pose;for(const n in t)if("BindPose"===t[n].attrType&&t[n].NbPoseNodes>0){const o=t[n].PoseNode;Array.isArray(o)?o.forEach((function(t){e[t.Node]=(new r.yGw).fromArray(t.Matrix.a)})):e[o.Node]=(new r.yGw).fromArray(o.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in i&&"AmbientColor"in i.GlobalSettings){const e=i.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],o=e[2];if(0!==t||0!==n||0!==o){const e=new r.Ilk(t,n,o).convertSRGBToLinear();l.add(new r.Mig(e,1))}}}}class p{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in i.Objects){const n=i.Objects.Geometry;for(const r in n){const o=a.get(parseInt(r)),s=this.parseGeometry(o,n[r],e);t.set(parseInt(r),s)}}return!0===this.negativeMaterialIndices&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const r=n.skeletons,o=[],s=e.parents.map((function(e){return i.Objects.Model[e.ID]}));if(0===s.length)return;const a=e.children.reduce((function(e,t){return void 0!==r[t.ID]&&(e=r[t.ID]),e}),null);e.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&o.push(n.morphTargets[e.ID])}));const l=s[0],c={};"RotationOrder"in l&&(c.eulerOrder=S(l.RotationOrder.value)),"InheritType"in l&&(c.inheritType=parseInt(l.InheritType.value)),"GeometricTranslation"in l&&(c.translation=l.GeometricTranslation.value),"GeometricRotation"in l&&(c.rotation=l.GeometricRotation.value),"GeometricScaling"in l&&(c.scale=l.GeometricScaling.value);const u=T(c);return this.genGeometry(t,a,o,u)}genGeometry(e,t,n,o){const s=new r.u9r;e.attrName&&(s.name=e.attrName);const i=this.parseGeoNode(e,t),a=this.genBuffers(i),l=new r.a$l(a.vertex,3);if(l.applyMatrix4(o),s.setAttribute("position",l),a.colors.length>0&&s.setAttribute("color",new r.a$l(a.colors,3)),t&&(s.setAttribute("skinIndex",new r.qlB(a.weightsIndices,4)),s.setAttribute("skinWeight",new r.a$l(a.vertexWeights,4)),s.FBX_Deformer=t),a.normal.length>0){const e=(new r.Vkp).getNormalMatrix(o),t=new r.a$l(a.normal,3);t.applyNormalMatrix(e),s.setAttribute("normal",t)}if(a.uvs.forEach((function(e,t){const n=0===t?"uv":`uv${t}`;s.setAttribute(n,new r.a$l(a.uvs[t],2))})),i.material&&"AllSame"!==i.material.mappingType){let e=a.materialIndex[0],t=0;if(a.materialIndex.forEach((function(n,r){n!==e&&(s.addGroup(t,r-t,e),e=n,t=r)})),s.groups.length>0){const t=s.groups[s.groups.length-1],n=t.start+t.count;n!==a.materialIndex.length&&s.addGroup(n,a.materialIndex.length-n,e)}0===s.groups.length&&s.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(s,e,n,o),s}parseGeoNode(e,t){const n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(r,o){void 0===n.weightTable[r]&&(n.weightTable[r]=[]),n.weightTable[r].push({id:t,weight:e.weights[o]})}))}))),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,r=0,o=!1,s=[],i=[],a=[],l=[],c=[],u=[];const p=this;return e.vertexIndices.forEach((function(d,h){let m,f=!1;d<0&&(d^=-1,f=!0);let g=[],y=[];if(s.push(3*d,3*d+1,3*d+2),e.color){const t=I(h,n,d,e.color);a.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){y.push(e.weight),g.push(e.id)})),y.length>4){o||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),o=!0);const e=[0,0,0,0],t=[0,0,0,0];y.forEach((function(n,r){let o=n,s=g[r];t.forEach((function(t,n,r){if(o>t){r[n]=o,o=t;const i=e[n];e[n]=s,s=i}}))})),g=e,y=t}for(;y.length<4;)y.push(0),g.push(0);for(let e=0;e<4;++e)c.push(y[e]),u.push(g[e])}if(e.normal){const t=I(h,n,d,e.normal);i.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(m=I(h,n,d,e.material)[0],m<0&&(p.negativeMaterialIndices=!0,m=0)),e.uv&&e.uv.forEach((function(e,t){const r=I(h,n,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(r[0]),l[t].push(r[1])})),r++,f&&(r>4&&console.warn("THREE.FBXLoader: Polygons with more than four sides are not supported. Make sure to triangulate the geometry during export."),p.genFace(t,e,s,m,i,a,l,c,u,r),n++,r=0,s=[],i=[],a=[],l=[],c=[],u=[])})),t}genFace(e,t,n,r,o,s,i,a,l,c){for(let u=2;u<c;u++)e.vertex.push(t.vertexPositions[n[0]]),e.vertex.push(t.vertexPositions[n[1]]),e.vertex.push(t.vertexPositions[n[2]]),e.vertex.push(t.vertexPositions[n[3*(u-1)]]),e.vertex.push(t.vertexPositions[n[3*(u-1)+1]]),e.vertex.push(t.vertexPositions[n[3*(u-1)+2]]),e.vertex.push(t.vertexPositions[n[3*u]]),e.vertex.push(t.vertexPositions[n[3*u+1]]),e.vertex.push(t.vertexPositions[n[3*u+2]]),t.skeleton&&(e.vertexWeights.push(a[0]),e.vertexWeights.push(a[1]),e.vertexWeights.push(a[2]),e.vertexWeights.push(a[3]),e.vertexWeights.push(a[4*(u-1)]),e.vertexWeights.push(a[4*(u-1)+1]),e.vertexWeights.push(a[4*(u-1)+2]),e.vertexWeights.push(a[4*(u-1)+3]),e.vertexWeights.push(a[4*u]),e.vertexWeights.push(a[4*u+1]),e.vertexWeights.push(a[4*u+2]),e.vertexWeights.push(a[4*u+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(u-1)]),e.weightsIndices.push(l[4*(u-1)+1]),e.weightsIndices.push(l[4*(u-1)+2]),e.weightsIndices.push(l[4*(u-1)+3]),e.weightsIndices.push(l[4*u]),e.weightsIndices.push(l[4*u+1]),e.weightsIndices.push(l[4*u+2]),e.weightsIndices.push(l[4*u+3])),t.color&&(e.colors.push(s[0]),e.colors.push(s[1]),e.colors.push(s[2]),e.colors.push(s[3*(u-1)]),e.colors.push(s[3*(u-1)+1]),e.colors.push(s[3*(u-1)+2]),e.colors.push(s[3*u]),e.colors.push(s[3*u+1]),e.colors.push(s[3*u+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(r),e.materialIndex.push(r),e.materialIndex.push(r)),t.normal&&(e.normal.push(o[0]),e.normal.push(o[1]),e.normal.push(o[2]),e.normal.push(o[3*(u-1)]),e.normal.push(o[3*(u-1)+1]),e.normal.push(o[3*(u-1)+2]),e.normal.push(o[3*u]),e.normal.push(o[3*u+1]),e.normal.push(o[3*u+2])),t.uv&&t.uv.forEach((function(t,n){void 0===e.uvs[n]&&(e.uvs[n]=[]),e.uvs[n].push(i[n][0]),e.uvs[n].push(i[n][1]),e.uvs[n].push(i[n][2*(u-1)]),e.uvs[n].push(i[n][2*(u-1)+1]),e.uvs[n].push(i[n][2*u]),e.uvs[n].push(i[n][2*u+1])}))}addMorphTargets(e,t,n,r){if(0===n.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const o=this;n.forEach((function(n){n.rawTargets.forEach((function(n){const s=i.Objects.Geometry[n.geoID];void 0!==s&&o.genMorphGeometry(e,t,s,r,n.name)}))}))}genMorphGeometry(e,t,n,o,s){const i=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],a=void 0!==n.Vertices?n.Vertices.a:[],l=void 0!==n.Indexes?n.Indexes.a:[],c=3*e.attributes.position.count,u=new Float32Array(c);for(let e=0;e<l.length;e++){const t=3*l[e];u[t]=a[3*e],u[t+1]=a[3*e+1],u[t+2]=a[3*e+2]}const p={vertexIndices:i,vertexPositions:u},d=this.genBuffers(p),h=new r.a$l(d.vertex,3);h.name=s||n.attrName,h.applyMatrix4(o),e.morphAttributes.position.push(h)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.Normals.a;let o=[];return"IndexToDirect"===n&&("NormalIndex"in e?o=e.NormalIndex.a:"NormalsIndex"in e&&(o=e.NormalsIndex.a)),{dataSize:3,buffer:r,indices:o,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.UV.a;let o=[];return"IndexToDirect"===n&&(o=e.UVIndex.a),{dataSize:2,buffer:r,indices:o,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,o=e.Colors.a;let s=[];"IndexToDirect"===n&&(s=e.ColorIndex.a);for(let e=0,t=new r.Ilk;e<o.length;e+=4)t.fromArray(o,e).convertSRGBToLinear().toArray(o,e);return{dataSize:4,buffer:o,indices:s,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const r=e.Materials.a,o=[];for(let e=0;e<r.length;++e)o.push(e);return{dataSize:1,buffer:r,indices:o,mappingType:t,referenceType:n}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new r.u9r;const n=t-1,o=e.KnotVector.a,i=[],a=e.Points.a;for(let e=0,t=a.length;e<t;e+=4)i.push((new r.Ltg).fromArray(a,e));let l,c;if("Closed"===e.Form)i.push(i[0]);else if("Periodic"===e.Form){l=n,c=o.length-1-l;for(let e=0;e<n;++e)i.push(i[e])}const u=new s.e(n,o,i,l,c).getPoints(12*i.length);return(new r.u9r).setFromPoints(u)}}class d{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const n in t){const r=t[n],o=this.addClip(r);e.push(o)}return e}parseClips(){if(void 0===i.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=i.Objects.AnimationCurveNode,t=new Map;for(const n in e){const r=e[n];if(null!==r.attrName.match(/S|R|T|DeformPercent/)){const e={id:r.id,attr:r.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=i.Objects.AnimationCurve;for(const n in t){const r={id:t[n].id,times:t[n].KeyTime.a.map(v),values:t[n].KeyValueFloat.a},o=a.get(r.id);if(void 0!==o){const t=o.parents[0].ID,n=o.parents[0].relationship;n.match(/X/)?e.get(t).curves.x=r:n.match(/Y/)?e.get(t).curves.y=r:n.match(/Z/)?e.get(t).curves.z=r:n.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=r)}}}parseAnimationLayers(e){const t=i.Objects.AnimationLayer,n=new Map;for(const o in t){const t=[],s=a.get(parseInt(o));if(void 0!==s){s.children.forEach((function(n,o){if(e.has(n.ID)){const s=e.get(n.ID);if(void 0!==s.curves.x||void 0!==s.curves.y||void 0!==s.curves.z){if(void 0===t[o]){const e=a.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const s=i.Objects.Model[e.toString()];if(void 0===s)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",n);const a={modelName:s.attrName?r.iUV.sanitizeNodeName(s.attrName):"",ID:s.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};l.traverse((function(e){e.ID===s.id&&(a.transform=e.matrix,e.userData.transformData&&(a.eulerOrder=e.userData.transformData.eulerOrder))})),a.transform||(a.transform=new r.yGw),"PreRotation"in s&&(a.preRotation=s.PreRotation.value),"PostRotation"in s&&(a.postRotation=s.PostRotation.value),t[o]=a}}t[o]&&(t[o][s.attr]=s)}else if(void 0!==s.curves.morph){if(void 0===t[o]){const e=a.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,s=a.get(e).parents[0].ID,l=a.get(s).parents[0].ID,c=a.get(l).parents[0].ID,u=i.Objects.Model[c],p={modelName:u.attrName?r.iUV.sanitizeNodeName(u.attrName):"",morphName:i.Objects.Deformer[e].attrName};t[o]=p}t[o][s.attr]=s}}})),n.set(parseInt(o),t)}}return n}parseAnimStacks(e){const t=i.Objects.AnimationStack,n={};for(const r in t){const o=a.get(parseInt(r)).children;o.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const s=e.get(o[0].ID);n[r]={name:t[r].attrName,layer:s}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach((function(e){t=t.concat(n.generateTracks(e))})),new r.m7l(e.name,-1,t)}generateTracks(e){const t=[];let n=new r.Pa4,o=new r._fP,s=new r.Pa4;if(e.transform&&e.transform.decompose(n,o,s),n=n.toArray(),o=(new r.USm).setFromQuaternion(o,e.eulerOrder).toArray(),s=s.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==r&&t.push(r)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const n=this.generateRotationTrack(e.modelName,e.R.curves,o,e.preRotation,e.postRotation,e.eulerOrder);void 0!==n&&t.push(n)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const n=this.generateVectorTrack(e.modelName,e.S.curves,s,"scale");void 0!==n&&t.push(n)}if(void 0!==e.DeformPercent){const n=this.generateMorphTrack(e);void 0!==n&&t.push(n)}return t}generateVectorTrack(e,t,n,o){const s=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(s,t,n);return new r.yC1(e+"."+o,s,i)}generateRotationTrack(e,t,n,o,s,i){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(r.M8C.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(r.M8C.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(r.M8C.degToRad));const a=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(a,t,n);void 0!==o&&((o=o.map(r.M8C.degToRad)).push(i),o=(new r.USm).fromArray(o),o=(new r._fP).setFromEuler(o)),void 0!==s&&((s=s.map(r.M8C.degToRad)).push(i),s=(new r.USm).fromArray(s),s=(new r._fP).setFromEuler(s).invert());const c=new r._fP,u=new r.USm,p=[];for(let e=0;e<l.length;e+=3)u.set(l[e],l[e+1],l[e+2],i),c.setFromEuler(u),void 0!==o&&c.premultiply(o),void 0!==s&&c.multiply(s),c.toArray(p,e/3*4);return new r.iLg(e+".quaternion",a,p)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),o=l.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new r.dUE(e.modelName+".morphTargetInfluences["+o+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,n=t[0];for(let r=1;r<t.length;r++){const o=t[r];o!==n&&(t[e]=o,n=o,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,n){const r=n,o=[];let s=-1,i=-1,a=-1;return e.forEach((function(e){if(t.x&&(s=t.x.times.indexOf(e)),t.y&&(i=t.y.times.indexOf(e)),t.z&&(a=t.z.times.indexOf(e)),-1!==s){const e=t.x.values[s];o.push(e),r[0]=e}else o.push(r[0]);if(-1!==i){const e=t.y.values[i];o.push(e),r[1]=e}else o.push(r[1]);if(-1!==a){const e=t.z.values[a];o.push(e),r[2]=e}else o.push(r[2])})),o}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const n=e.values[t-1],r=e.values[t]-n,o=Math.abs(r);if(o>=180){const s=o/180,i=r/s;let a=n+i;const l=e.times[t-1],c=(e.times[t]-l)/s;let u=l+c;const p=[],d=[];for(;u<e.times[t];)p.push(u),u+=c,d.push(a),a+=i;e.times=L(e.times,t,p),e.values=L(e.values,t,d)}}}}class h{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new g,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach((function(e,r){const o=e.match(/^[\s\t]*;/),s=e.match(/^[\s\t]*$/);if(o||s)return;const i=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),a=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");i?t.parseNodeBegin(e,i):a?t.parseNodeProperty(e,a,n[++r]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),r=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),o={name:n},s=this.parseNodeAttr(r),i=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,o):n in i?("PoseNode"===n?i.PoseNode.push(o):void 0!==i[n].id&&(i[n]={},i[n][i[n].id]=i[n]),""!==s.id&&(i[n][s.id]=o)):"number"==typeof s.id?(i[n]={},i[n][s.id]=o):"Properties70"!==n&&(i[n]="PoseNode"===n?[o]:o),"number"==typeof s.id&&(o.id=s.id),""!==s.name&&(o.attrName=s.name),""!==s.type&&(o.attrType=s.type),this.pushStack(o)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",r="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),r=e[2]),{id:t,name:n,type:r}}parseNodeProperty(e,t,n){let r=t[1].replace(/^"/,"").replace(/"$/,"").trim(),o=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===r&&","===o&&(o=n.replace(/"/g,"").replace(/,$/,"").trim());const s=this.getCurrentNode();if("Properties70"!==s.name){if("C"===r){const e=o.split(",").slice(1),t=parseInt(e[0]),n=parseInt(e[1]);let i=o.split(",").slice(3);i=i.map((function(e){return e.trim().replace(/^"/,"")})),r="connections",o=[t,n],function(e,t){for(let n=0,r=e.length,o=t.length;n<o;n++,r++)e[r]=t[n]}(o,i),void 0===s[r]&&(s[r]=[])}"Node"===r&&(s.id=o),r in s&&Array.isArray(s[r])?s[r].push(o):"a"!==r?s[r]=o:s.a=o,this.setCurrentProp(s,r),"a"===r&&","!==o.slice(-1)&&(s.a=A(o))}else this.parseNodeSpecialProperty(e,r,o)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=A(t.a))}parseNodeSpecialProperty(e,t,n){const r=n.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),o=r[0],s=r[1],i=r[2],a=r[3];let l=r[4];switch(s){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=A(l)}this.getPrevNode()[o]={type:s,type2:i,flag:a,value:l},this.setCurrentProp(this.getPrevNode(),o)}}class m{parse(e){const t=new f(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const r=new g;for(;!this.endOfContent(t);){const e=this.parseNode(t,n);null!==e&&r.add(e.name,e)}return r}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},r=t>=7500?e.getUint64():e.getUint32(),o=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const s=e.getUint8(),i=e.getString(s);if(0===r)return null;const a=[];for(let t=0;t<o;t++)a.push(this.parseProperty(e));const l=a.length>0?a[0]:"",c=a.length>1?a[1]:"",u=a.length>2?a[2]:"";for(n.singleProperty=1===o&&e.getOffset()===r;r>e.getOffset();){const r=this.parseNode(e,t);null!==r&&this.parseSubNode(i,n,r)}return n.propertyList=a,"number"==typeof l&&(n.id=l),""!==c&&(n.attrName=c),""!==u&&(n.attrType=u),""!==i&&(n.name=i),n}parseSubNode(e,t,n){if(!0===n.singleProperty){const e=n.propertyList[0];Array.isArray(e)?(t[n.name]=n,n.a=e):t[n.name]=e}else if("Connections"===e&&"C"===n.name){const e=[];n.propertyList.forEach((function(t,n){0!==n&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===n.name){Object.keys(n).forEach((function(e){t[e]=n[e]}))}else if("Properties70"===e&&"P"===n.name){let e=n.propertyList[0],r=n.propertyList[1];const o=n.propertyList[2],s=n.propertyList[3];let i;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===r.indexOf("Lcl ")&&(r=r.replace("Lcl ","Lcl_")),i="Color"===r||"ColorRGB"===r||"Vector"===r||"Vector3D"===r||0===r.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[e]={type:r,type2:o,flag:s,value:i}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const r=e.getUint32(),s=e.getUint32(),i=e.getUint32();if(0===s)switch(t){case"b":case"c":return e.getBooleanArray(r);case"d":return e.getFloat64Array(r);case"f":return e.getFloat32Array(r);case"i":return e.getInt32Array(r);case"l":return e.getInt64Array(r)}const a=o.HT(new Uint8Array(e.getArrayBuffer(i))),l=new f(a.buffer);switch(t){case"b":case"c":return l.getBooleanArray(r);case"d":return l.getFloat64Array(r);case"f":return l.getFloat32Array(r);case"i":return l.getInt32Array(r);case"l":return l.getInt64Array(r)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class f{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let n=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const r=n.indexOf(0);return r>=0&&(n=new Uint8Array(this.dv.buffer,t,r)),this._textDecoder.decode(n)}}class g{add(e,t){this[e]=t}}function y(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function v(e){return e/46186158e3}const w=[];function I(e,t,n,r){let o;switch(r.mappingType){case"ByPolygonVertex":o=e;break;case"ByPolygon":o=t;break;case"ByVertice":o=n;break;case"AllSame":o=r.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+r.mappingType)}"IndexToDirect"===r.referenceType&&(o=r.indices[o]);const s=o*r.dataSize,i=s+r.dataSize;return function(e,t,n,r){for(let o=n,s=0;o<r;o++,s++)e[s]=t[o];return e}(w,r.buffer,s,i)}const x=new r.USm,b=new r.Pa4;function T(e){const t=new r.yGw,n=new r.yGw,o=new r.yGw,s=new r.yGw,i=new r.yGw,a=new r.yGw,l=new r.yGw,c=new r.yGw,u=new r.yGw,p=new r.yGw,d=new r.yGw,h=new r.yGw,m=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(b.fromArray(e.translation)),e.preRotation){const t=e.preRotation.map(r.M8C.degToRad);t.push(e.eulerOrder||r.USm.DEFAULT_ORDER),n.makeRotationFromEuler(x.fromArray(t))}if(e.rotation){const t=e.rotation.map(r.M8C.degToRad);t.push(e.eulerOrder||r.USm.DEFAULT_ORDER),o.makeRotationFromEuler(x.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(r.M8C.degToRad);t.push(e.eulerOrder||r.USm.DEFAULT_ORDER),s.makeRotationFromEuler(x.fromArray(t)),s.invert()}e.scale&&i.scale(b.fromArray(e.scale)),e.scalingOffset&&l.setPosition(b.fromArray(e.scalingOffset)),e.scalingPivot&&a.setPosition(b.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(b.fromArray(e.rotationOffset)),e.rotationPivot&&u.setPosition(b.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(d.copy(e.parentMatrix),p.copy(e.parentMatrixWorld));const f=n.clone().multiply(o).multiply(s),g=new r.yGw;g.extractRotation(p);const y=new r.yGw;y.copyPosition(p);const v=y.clone().invert().multiply(p),w=g.clone().invert().multiply(v),I=i,T=new r.yGw;if(0===m)T.copy(g).multiply(f).multiply(w).multiply(I);else if(1===m)T.copy(g).multiply(w).multiply(f).multiply(I);else{const e=(new r.yGw).scale((new r.Pa4).setFromMatrixScale(d)).clone().invert(),t=w.clone().multiply(e);T.copy(g).multiply(f).multiply(t).multiply(I)}const S=u.clone().invert(),A=a.clone().invert();let P=t.clone().multiply(c).multiply(u).multiply(n).multiply(o).multiply(s).multiply(S).multiply(l).multiply(a).multiply(i).multiply(A);const L=(new r.yGw).copyPosition(P),E=p.clone().multiply(L);return h.copyPosition(E),P=h.clone().multiply(T),P.premultiply(p.invert()),P}function S(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function A(e){return e.split(",").map((function(e){return parseFloat(e)}))}function P(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,n))}function L(e,t,n){return e.slice(0,t).concat(n).concat(e.slice(t))}}}]);