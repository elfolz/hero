(self.webpackChunkhero=self.webpackChunkhero||[]).push([[613],{598:(i,t,e)=>{e.d(t,{l:()=>f});var s=e(479),n=e(577),a=e(527),o=e(944),h=e(815);class r{constructor(i,t){this.callback=i,this.onload=t,this.gltfLoader=new n.E,this.fbxLoader=new a.y,this.textureLoader=new s.dpR,this.caster=new s.iMs,this.vertex=new s.Pa4,this.position=new s.Pa4,this.scale=new s.Pa4,this.roration=new s.Pa4,this.box1=new s.ZzF,this.box2=new s.ZzF,this.progress=[],this.animations=[],this.audios={},this.pendingSounds=[],this.setupLoading(),this.loadModel(),this.setupDecalMaterial()}setupLoading(){if(!this.onload)return;const i=this;this.progress=new Proxy({},{set:function(t,e,s){t[e]=s;let n=Object.values(t).slice().reduce(((i,t)=>i+t),0);return n/=i.loadingElements,i.onload(n),!0}})}setupDecalMaterial(){this.decalMaterial=new s.xoR({specular:4473924,shininess:30,color:16711680,map:this.textureLoader.load("/textures/decal-diffuse.png"),normalMap:this.textureLoader.load("/textures/decal-normal.jpg"),transparent:!0,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-4,wireframe:!1})}update(i){this.dead||(window.game.pause||this.mixer?.update(i),this.object&&this.updateActions())}executeCrossFade(i,t=.25,e="repeat"){if(this.lastAction&&i&&(!this.died||"die"==i.name)){if(this.lastAction==i)return i.reset();i.enabled=!0,i.setEffectiveTimeScale(1),i.setEffectiveWeight(1),i.loop="pingpong"==e?s.uEv:"once"==e?s.jAl:s.YKA,i.clampWhenFinished="once"==e,"once"==e&&i.reset(),this.lastAction.crossFadeTo(i,t,!0),this.lastAction=i,i.play()}}synchronizeCrossFade(i,t=.25,e="repeat"){this.mixer.addEventListener("finished",(function n(a){s.mixer.removeEventListener("finished",n),s.executeCrossFade(i,t,e)}));const s=this}updateObjectFollow(i,t,e){!e&&this.movingSpeed?e=this.movingSpeed:e||(e=.01);const s=Math.min(60*e/window.game.fps,e),n=i.object.position.clone(),a=this.object.position.clone().sub(n).multiplyScalar(t?s:-1*s);this.object.lookAt(n),this.object.position.add(a)}getDistance(i){if(!this.collider||!i.collider)return;if(this.lastCollisionUpdate>performance.now()-500)return;this.lastCollisionUpdate=performance.now();let t=this.collider.geometry.attributes.position;for(let e=0;e<t.count;e++){let s=this.vertex.fromBufferAttribute(t,e).applyMatrix4(this.object.matrix).sub(this.object.position);this.caster.set(this.object.position,s.normalize());let n=this.caster.intersectObjects([i.collider]),a=n.length>0&&n[0].distance<s.length();if(n.length>0)return{distance:n[0].distance,collided:a}}}hasHit(i,t="weapon",e="pillar"){if(this[t]&&i[e])return this[t].updateMatrixWorld(!0),i[e].updateMatrixWorld(!0),this.box1.copy(this[t].geometry.boundingBox),this.box1.applyMatrix4(this[t].matrixWorld),this.box2.copy(i[e].geometry.boundingBox),this.box2.applyMatrix4(i[e].matrixWorld),this.box1.intersectsBox(this.box2)}async fetchAudio(i,t,e=!1,s=10,n=100){if(window.sound?.audioContext)try{let a=await fetch(t,{cache:"force-cache"}),o=await a.arrayBuffer(),h=await window.sound.audioContext.decodeAudioData(o);this.audios[i]=h,e&&this.setPositionalAudio(i,h,s,n)}catch(i){console.log(i)}}setPositionalAudio(i,t,e=10,n=100){if(!window.sound?.audioListener)return;const a=new s.VYz(window.sound?.audioListener);a.name=i,a.setBuffer(t),a.setRefDistance(e),a.setMaxDistance(n),a.onEnded=()=>{a.stop(),this.se=void 0},this.object?this.object.add(a):this.pendingSounds.push(a)}setupBlood(){if(!this.pillar)return;this.position=this.pillar.position.clone(),this.roration.z=2*Math.random()*Math.PI;let i=(0,h.Z)(3,5,!1);this.scale.set(i,i,i);const t=new o.k(this.pillar,this.position,this.roration,this.scale),e=new s.Kj0(t,this.decalMaterial);e.receiveShadow=!0,window.game.scene.add(e)}loadModel(){}initAudio(){}updateActions(){}resizeScene(){}toggleVisibility(){}setupDamage(i){}}class c extends r{loadingElements=6;movingSpeed=.001;animationModels=["idle","walk","attack","hit","die"];constructor(i,t,e){super(t,e),this.player=i,this.hp=100,this.maxhp=100}loadModel(){this.gltfLoader.load("./models/humanoid/humanoid.glb",(i=>{this.object=i.scene,this.object.colorSpace=s.KI_,this.object.traverse((i=>{i.isMesh&&(i.castShadow=!0)})),this.object.position.set(0,0,20),this.object.lookAt(0,0,-1),this.mixer=new s.Xcj(this.object),this.collider=new s.Kj0(new s.xo$(1.1),new s.vBJ({visible:!1})),this.collider.name="collider",this.object.add(this.collider),this.collider.geometry.computeBoundingBox(),this.pillar=new s.Kj0(new s.fHI(.6,.6,2.6),new s.vBJ({visible:!1})),this.pillar.name="pillar",this.pillar.rotation.x=Math.PI/2-.12,this.pillar.position.z-=5.5,this.object.add(this.pillar),this.object.getObjectByName("mixamorigSpine1").attach(this.pillar),this.pillar.geometry.computeBoundingBox(),this.weapon=new s.Kj0(new s.xo$(.35),new s.vBJ({visible:!1})),this.weapon.name="weapon",this.weapon.position.set(this.object.position.x+3.7,this.object.position.y-.3,this.object.position.z+6.5),this.object.getObjectByName("mixamorigRightHand").attach(this.weapon),this.weapon.geometry.computeBoundingBox(),this.onFinishActions(),this.loadAnimations(),this.callback(this.object),this.pendingSounds.forEach((i=>this.object.add(i))),this.pendingSounds.splice(0),this.progress.foe=100}),(i=>{this.progress.foe=99*parseInt(i.loaded/(i.total||1))}),(i=>{console.error(i)}))}loadAnimations(){this.animationModels.forEach((i=>{this.fbxLoader.load(`./models/humanoid/${i}.fbx`,(t=>{this.animations[i]=this.mixer.clipAction(t.animations[0]),this.animations[i].name=i,"idle"==i&&(this.lastAction=this.animations[i],this.animations[i].play()),this.progress[i]=100}),(t=>{this.progress[i]=99*parseInt(t.loaded/(t.total||1))}),(i=>{console.error(i)}))}))}update(i){super.update(i),this.processingAttack&&this.executeMelleeAttack()}updateActions(){if(location.search.includes("stop-enemy"))return;if(this.isAttacking||this.beenHit||this.died)return;let i=this.getDistance(this.player);if(i?.distance<=3.5&&!this.isAttacking){this.isAttacking=!0,this.waitForAnimation=!0;let i=.1;this.executeCrossFade(this.animations.attack,i,"once"),setTimeout((()=>this.executeMelleeAttack()),window.game.delay*(1e3*i*4/3))}if(!this.waitForAnimation){if(this.isWalking){if(!this.se){let i=this.object.children.filter((i=>"Audio"==i.type));if(!i.length)return;let t=(0,h.Z)(0,i.length-1);i[t]&&!i[t].isPlaying&&(i[t].play(),this.se=i[t])}this.updateObjectFollow(this.player,i?.collided)}i?.distance<200&&!this.isWalking?(this.isWalking=!0,this.executeCrossFade(this.animations.walk)):i?.distance>=200&&this.isWalking&&(this.isWalking=!1,this.synchronizeCrossFade(this.animations.idle))}}onFinishActions(){this.mixer.addEventListener("finished",(()=>{this.waitForAnimation=!1,this.isAttacking=!1,this.processingAttack=!1,this.beenHit=!1,this.executeCrossFade(this.returnAction)}))}initAudio(){for(let i=0;i<9;i++)this.fetchAudio(`attack-${i}`,`./audio/monster/homanoid-${i}.mp3`,!0)}executeMelleeAttack(){if(!this.isAttacking)return;let i=this.hasHit(this.player);i&&Math.random()<=.75&&this.player.setupDamage(10),this.processingAttack=!i}setupDamage(i){if(this.hp-=i,this.hp<0&&(this.hp=0),this.waitForAnimation=!0,this.beenHit=!0,this.executeCrossFade(this.animations.hit,.1,"once"),this.hp<=0&&!this.died){let i=this.object.children.find((i=>"attack-8"==i.name));i.play(),this.se=i,this.executeCrossFade(this.animations.die,1,"once"),this.died=!0}}get returnAction(){return this.isWalking?this.animations.walk:this.animations.idle}}var d=e(219),l=e(934);class u extends r{loadingElements=16;animationModels=["idle","running","walkingBack","jumping","jumpingRunning","backflip","kick","rolling","outwardSlash","inwardSlash","stomachHit","dieing","drinking","walking"];constructor(i,t,e){super(t,e),this.camera=i,this.actions=[],this.keysPressed={},this.potions=3,this.hp=100,this.maxhp=100,this.initControls()}update(i){super.update(i),this.gamepadConnected&&this.updateGamepad(),this.processingAttack&&this.executeMelleeAttack()}loadModel(){this.gltfLoader.load("./models/hero/hero.glb",(i=>{this.object=i.scene,this.object.colorSpace=s.KI_,this.object.traverse((i=>{i.isMesh&&(i.castShadow=!0)})),this.camera.position.set(0,this.object.position.y+5,this.object.position.z-15),this.camera.lookAt(0,5,0),this.object.add(this.camera),this.mixer=new s.Xcj(this.object),this.collider=new s.Kj0(new s.xo$(.8),new s.vBJ({visible:!1})),this.collider.name="collider",this.object.add(this.collider),this.collider.geometry.computeBoundingBox(),this.pillar=new s.Kj0(new s.fHI(.6,.6,2.5),new s.vBJ({visible:!1})),this.pillar.name="pillar",this.pillar.rotation.x=Math.PI/2-.25,this.pillar.rotation.y+=.25,this.pillar.position.z-=4.8,this.object.add(this.pillar),this.object.getObjectByName("mixamorigSpine1").attach(this.pillar),this.pillar.geometry.computeBoundingBox(),this.onFinishActions(),this.loadWeapon(),this.callback(this.object),this.progress.player=100}),(i=>{this.progress.player=99*parseInt(i.loaded/(i.total||1))}),(i=>{console.error(i)}))}loadWeapon(){this.gltfLoader.load("./models/equips/sword.glb",(i=>{this.sword=i.scene,this.sword.colorSpace=s.KI_,this.sword.traverse((i=>{i.isMesh&&(i.castShadow=!0,this.weapon||(this.weapon=i))})),this.weapon.geometry.computeBoundingBox(),this.sword.rotation.y=Math.PI/6,this.sword.position.set(this.object.position.x-2.6,this.object.position.y+.6,this.object.position.z-4),this.object.getObjectByName("mixamorigRightHand").attach(this.sword),this.progress.sword=100,this.loadAnimations()}),(i=>{this.progress.sword=99*parseInt(i.loaded/(i.total||1))}),(i=>{console.error(i)}))}loadAnimations(){this.animationModels.forEach((i=>{this.fbxLoader.load(`./models/hero/${i}.fbx`,(t=>{this.animations[i]=this.mixer.clipAction(t.animations[0]),this.animations[i].name=i,this.progress[i]=100,"idle"==i&&(this.lastAction=this.animations.idle,this.animations.idle.play())}),(t=>{this.progress[i]=99*parseInt(t.loaded/(t.total||1))}),(i=>{console.error(i)}))}))}initControls(){window.addEventListener("gamepadconnected",(i=>{this.gamepadConnected=!0;let t="default",e=/vendor:\s(\w+)\sproduct:\s(\w+)/i.exec(i.gamepad.id);e&&(t=e[1]),this.gamepadSettings=d.Z.gamepad[t]??d.Z.gamepad.default,window.refreshControlsMenu()})),window.addEventListener("gamepaddisconnected",(i=>{this.gamepadConnected=!1,window.refreshControlsMenu()})),window.onkeydown=i=>{this.keysPressed[i.keyCode]=!0,this.keysPressed[d.Z.keyboard.keySlash]&&!this.actions.includes("slash")&&this.actions.push("slash"),this.keysPressed[d.Z.keyboard.keyTurnLeft]&&!this.actions.includes("turningLeft")&&this.actions.push("turningLeft"),this.keysPressed[d.Z.keyboard.keyTurnRight]&&!this.actions.includes("turningRight")&&this.actions.push("turningRight"),this.keysPressed[d.Z.keyboard.keyWalk]&&!this.actions.includes("walking")&&this.actions.push("walking"),this.keysPressed[d.Z.keyboard.keyBackflip]&&!this.actions.includes("backflip")&&this.actions.push("backflip"),this.keysPressed[d.Z.keyboard.keyStepBack]&&!this.actions.includes("walkingBack")&&this.actions.push("walkingBack"),this.keysPressed[d.Z.keyboard.keyJump]&&!this.actions.includes("jumping")&&this.actions.push("jumping"),this.keysPressed[d.Z.keyboard.keyKick]&&!this.actions.includes("kick")&&this.actions.push("kick"),this.keysPressed[d.Z.keyboard.keyRoll]&&!this.actions.includes("rolling")&&this.actions.push("rolling"),this.keysPressed[d.Z.keyboard.keyHeal]&&!this.actions.includes("drinking")&&this.actions.push("drinking"),this.keysPressed[d.Z.keyboard.keyPause]&&window.game.togglePause()},window.onkeyup=i=>{this.keysPressed[i.keyCode]=!1,i.keyCode==d.Z.keyboard.keySlash&&this.actions.splice(this.actions.findIndex((i=>"slash"==i)),1),i.keyCode==d.Z.keyboard.keyTurnLeft&&this.actions.splice(this.actions.findIndex((i=>"turningLeft"==i)),1),i.keyCode==d.Z.keyboard.keyTurnRight&&this.actions.splice(this.actions.findIndex((i=>"turningRight"==i)),1),i.keyCode==d.Z.keyboard.keyWalk&&this.actions.splice(this.actions.findIndex((i=>"walking"==i)),1),i.keyCode==d.Z.keyboard.keyBackflip&&this.actions.splice(this.actions.findIndex((i=>"backflip"==i)),1),i.keyCode==d.Z.keyboard.keyStepBack&&this.actions.splice(this.actions.findIndex((i=>"walkingBack"==i)),1),i.keyCode==d.Z.keyboard.keyJump&&this.actions.splice(this.actions.findIndex((i=>"jumping"==i)),1),i.keyCode==d.Z.keyboard.keyKick&&this.actions.splice(this.actions.findIndex((i=>"kick"==i)),1),i.keyCode==d.Z.keyboard.keyRoll&&this.actions.splice(this.actions.findIndex((i=>"rolling"==i)),1),i.keyCode==d.Z.keyboard.keyHeal&&this.actions.splice(this.actions.findIndex((i=>"drinking"==i)),1)};const i=document.querySelector("#button-forward");i.ontouchstart=t=>{this.actions.includes("walking")||this.actions.push("walking"),i.classList.add("active")},i.ontouchmove=t=>{if(t.cancelable&&(t.preventDefault(),t.stopPropagation()),!i.posX&&i.getClientRects()&&(i.posX=i.getClientRects()[0].x),t.changedTouches[0].pageX<i.posX){if(this.actions.includes("turningLeft"))return;this.actions.push("turningLeft"),document.querySelector("#button-left").classList.add("active")}else this.actions.includes("turningLeft")&&(this.actions.splice(this.actions.findIndex((i=>"turningLeft"==i)),1),document.querySelector("#button-left").classList.remove("active"));if(t.changedTouches[0].pageX>i.posX+64){if(this.actions.includes("turningRight"))return;this.actions.push("turningRight"),document.querySelector("#button-right").classList.add("active")}else this.actions.includes("turningRight")&&(this.actions.splice(this.actions.findIndex((i=>"turningRight"==i)),1),document.querySelector("#button-right").classList.remove("active"))},i.ontouchend=t=>{this.actions.splice(this.actions.findIndex((i=>"walking"==i)),1),this.actions.includes("turningLeft")&&this.actions.splice(this.actions.findIndex((i=>"turningLeft"==i)),1),this.actions.includes("turningRight")&&this.actions.splice(this.actions.findIndex((i=>"turningRight"==i)),1),i.classList.remove("active"),document.querySelector("#button-left").classList.remove("active"),document.querySelector("#button-right").classList.remove("active")},document.querySelector("#button-backward").ontouchstart=i=>{this.actions.includes("walkingBack")||this.actions.push("walkingBack")},document.querySelector("#button-backward").ontouchend=i=>{this.actions.splice(this.actions.findIndex((i=>"walkingBack"==i)),1)},document.querySelector("#button-left").ontouchstart=i=>{this.actions.includes("turningLeft")||this.actions.push("turningLeft")},document.querySelector("#button-left").ontouchend=i=>{this.actions.splice(this.actions.findIndex((i=>"turningLeft"==i)),1)},document.querySelector("#button-right").ontouchstart=i=>{this.actions.includes("turningRight")||this.actions.push("turningRight")},document.querySelector("#button-right").ontouchend=i=>{this.actions.splice(this.actions.findIndex((i=>"turningRight"==i)),1)},document.querySelector("#button-attack").ontouchstart=i=>{this.actions.includes("slash")||this.actions.push("slash")},document.querySelector("#button-attack").ontouchend=i=>{this.actions.splice(this.actions.findIndex((i=>"slash"==i)),1)},document.querySelector("#button-heal").ontouchstart=i=>{this.actions.includes("drinking")||this.actions.push("drinking")},document.querySelector("#button-heal").ontouchend=i=>{this.actions.splice(this.actions.findIndex((i=>"drinking"==i)),1)},document.querySelector("#button-kick").ontouchstart=i=>{this.actions.includes("kick")||this.actions.push("kick")},document.querySelector("#button-kick").ontouchend=i=>{this.actions.splice(this.actions.findIndex((i=>"kick"==i)),1)},document.querySelector("#button-jump").ontouchstart=i=>{this.actions.includes("jumping")||this.actions.push("jumping")},document.querySelector("#button-jump").ontouchend=i=>{this.actions.splice(this.actions.findIndex((i=>"jumping"==i)),1)}}updateGamepad(){if(this.gamepad=navigator.getGamepads().find((i=>i?.connected)),this.gamepad&&this.gamepadSettings&&!(this.gamepadLastUpdate>=this.gamepad.timestamp)){if(!window.sound.initialized&&this.gamepad.buttons.some((i=>i.pressed))&&window.sound.init(),this.gamepad.axes[this.gamepadSettings.YAxes]<=-.05?this.actions.includes("walking")||this.actions.push("walking"):this.actions.includes("walking")&&this.actions.splice(this.actions.findIndex((i=>"walking"==i)),1),this.gamepad.axes[this.gamepadSettings.YAxes]>=.5?this.actions.includes("walkingBack")||this.actions.push("walkingBack"):this.actions.includes("walkingBack")&&this.actions.splice(this.actions.findIndex((i=>"walkingBack"==i)),1),this.gamepad.axes[this.gamepadSettings.XAxes]<=-.05?this.actions.includes("turningLeft")||this.actions.push("turningLeft"):this.actions.includes("turningLeft")&&this.actions.splice(this.actions.findIndex((i=>"turningLeft"==i)),1),this.gamepad.axes[this.gamepadSettings.XAxes]>=.05?this.actions.includes("turningRight")||this.actions.push("turningRight"):this.actions.includes("turningRight")&&this.actions.splice(this.actions.findIndex((i=>"turningRight"==i)),1),this.gamepad.buttons[this.gamepadSettings.A].pressed)if(window.menuConfigOpened())window.executeMenuConfig();else{if(performance.now()<this.healLastUpdate)return;this.actions.includes("jumping")||this.actions.push("jumping"),this.healLastUpdate=performance.now()+250}else this.actions.includes("jumping")&&this.actions.splice(this.actions.findIndex((i=>"jumping"==i)),1);this.gamepad.buttons[this.gamepadSettings.B].pressed?document.querySelector("#dialog-controller").classList.contains("opened")?(document.querySelector("#dialog-controller").classList.remove("opened"),window.sound.playCancel()):window.menuConfigOpened()?window.toggleMenuConfig():this.actions.includes("rolling")||this.actions.push("rolling"):this.actions.includes("rolling")&&this.actions.splice(this.actions.findIndex((i=>"rolling"==i)),1),this.gamepad.buttons[this.gamepadSettings.X].pressed?this.actions.includes("backflip")||this.actions.push("backflip"):this.actions.includes("backflip")&&this.actions.splice(this.actions.findIndex((i=>"backflip"==i)),1),this.gamepad.buttons[this.gamepadSettings.Y].pressed?this.actions.includes("drinking")||this.actions.push("drinking"):this.actions.includes("drinking")&&this.actions.splice(this.actions.findIndex((i=>"drinking"==i)),1),this.gamepad.buttons[this.gamepadSettings.RB].pressed?this.actions.includes("slash")||this.actions.push("slash"):this.actions.includes("slash")&&this.actions.splice(this.actions.findIndex((i=>"slash"==i)),1),this.gamepad.buttons[this.gamepadSettings.LB].pressed?this.actions.includes("kick")||this.actions.push("kick"):this.actions.includes("kick")&&this.actions.splice(this.actions.findIndex((i=>"kick"==i)),1),this.gamepad.buttons[this.gamepadSettings.MENU].pressed&&window.game.togglePause(),this.gamepad.buttons[this.gamepadSettings.OPT].pressed&&window.toggleMenuConfig(!0),window.menuConfigOpened()&&(this.gamepad.buttons[this.gamepadSettings.UP]?.pressed&&window.navigateMenuConfig(-1),this.gamepad.buttons[this.gamepadSettings.DOWN]?.pressed&&window.navigateMenuConfig(1)),this.gamepadLastUpdate=this.gamepad.timestamp+100}}updateActions(){if(window.game.paused)return;let i=this.actions.includes("walking"),t=this.actions.includes("slash"),e=this.actions.includes("kick"),s=this.actions.includes("drinking"),n=this.actions.some((i=>["turningLeft","turningRight"].includes(i))),a=this.actions.includes("walkingBack"),o=this.actions.includes("backflip"),h=this.actions.includes("jumping"),r=this.actions.includes("rolling");if(this.actions.length<=0&&this.synchronizeCrossFade(this.animations.idle),!this.waitForAnimation&&s&&this.potions>0)this.isHealing=!0,this.waitForAnimation=!0,this.executeCrossFade(this.animations.drinking,.1,"once"),setTimeout((()=>{this.setupHeal()}),750*window.game.delay);else if(!this.waitForAnimation&&t){let i=.1;this.isSlashing=!0,this.waitForAnimation=!0,this.playAttackSE();let t="outwardSlash"==this.lastAction?.name?this.animations.inwardSlash:this.animations.outwardSlash;this.executeCrossFade(t,i,"once"),setTimeout((()=>this.executeMelleeAttack()),window.game.delay*(1e3*i*4/3))}else!this.waitForAnimation&&e?(this.isKicking=!0,this.waitForAnimation=!0,this.playAttackSE(),this.executeCrossFade(this.animations.kick,.1,"once")):this.waitForAnimation||!o||this.isBackingflip||(this.isBackingflip=!0,this.executeCrossFade(this.animations.backflip,.1,"once"),setTimeout((()=>{this.updateWalk(!1,!0,5)}),250*window.game.delay));if(!(this.waitForAnimation||this.isSlashing||this.isKicking||this.isBackingflip||(this.actions.includes("turningLeft")&&(this.object.rotation.y+=.025),this.actions.includes("turningRight")&&(this.object.rotation.y-=.025),i&&!this.isWalking?(this.isWalking=!0,this.executeCrossFade(this.animations.running)):!i&&this.isWalking&&(n||this.executeCrossFade(this.animations.idle),this.isWalking=!1,this.isRunning=!1),i&&this.updateWalk(!0),this.waitForAnimation||!r||this.isRolling||(this.isRolling=!0,this.executeCrossFade(this.animations.rolling,.25,"once")),this.isRolling||(this.waitForAnimation||!h||this.isJumping||(this.isJumping=!0,this.executeCrossFade(i?this.animations.jumpingRunning:this.animations.jumping,.25,"once")),i||this.isJumping)))){if(a&&!this.isSteppingBack?(this.isSteppingBack=!0,this.executeCrossFade(this.animations.walkingBack)):!a&&this.isSteppingBack&&(this.executeCrossFade(this.returnAction),this.isSteppingBack=!1),a)return this.updateWalk(!1,!0,.025);!this.isRotating&&n?(this.isRotating=!0,this.executeCrossFade(this.animations.walking)):this.isRotating&&!n&&(i||this.executeCrossFade(this.returnAction),this.isRotating=!1)}}updateWalk(i=!1,t=!1,e=.175){if(this.waitForAnimation)return;const s=Math.min(60*e/window.game.fps,e),n=this.camera.getWorldDirection(this.object.position.clone());t&&n.negate();const a=n.multiplyScalar(i?2.5*s:s),o=this.object.position.clone();o.add(a),o.x>=99||o.x<=-99||o.z>=99||o.z<=-99||this.object.position.add(a)}setupDamage(i){this.hp-=i,this.hp<0&&(this.hp=0),this.waitForAnimation=!0,this.beenHit=!0,this.refreshHPBar(),this.playDamageSE(),this.vibrate(),this.executeCrossFade(this.animations.stomachHit,.1,"once"),this.hp<=0&&!this.died&&(this.executeCrossFade(this.animations.dieing,1,"once"),window.sound.playME(window.sound.gameoverBuffer),this.died=!0)}setupHeal(){this.potions<=0||(this.potions--,this.playHealSE(),this.hp+=this.maxhp/2,this.hp>this.maxhp&&(this.hp=this.maxhp),this.refreshHPBar())}playAttackSE(){if(this.beenHit||this.sePlaying)return;const i=Object.keys(this.audios).filter((i=>i.startsWith("attack")));if(!i.length)return;let t=(0,h.Z)(0,i.length-1);this.sePlaying=!0,window.sound.playSE(this.audios[i[t]],!1,this)}playSlashSE(){const i=Object.keys(this.audios).filter((i=>i.startsWith("slash")));if(!i.length)return;let t=(0,h.Z)(0,i.length-1);window.sound.playSE(this.audios[i[t]],!1,this)}playDamageSE(){if(this.sePlaying)return;const i=Object.keys(this.audios).filter((i=>i.startsWith("damage")));if(!i.length)return;let t=(0,h.Z)(0,i.length-1);this.sePlaying=!0,window.sound.playSE(this.audios[i[t]],!1,this)}playHealSE(){this.sePlaying=!0,window.sound.playSE(this.audios.heal,!1,this)}gameover(){document.querySelector("#game-over").classList.add("show"),document.querySelector("header").style.setProperty("display","none"),document.querySelectorAll("footer").forEach((i=>i.style.setProperty("display","none"))),window.game.gameover=!0}refreshHPBar(){let i=document.querySelector("#hpbar").clientWidth-4,t=Math.max(0,this.hp)*i/this.maxhp;document.querySelector("#hpbar").style.setProperty("--hp-width",`${t}px`),document.querySelector("#count-heal").innerHTML=this.potions}executeCrossFade(i,t=.25,e="repeat"){i&&(this.actions.some((i=>["walking","running","turningLeft","turningRight","walkingBack"].includes(i)))&&"idle"==i.name||super.executeCrossFade(i,t,e))}synchronizeCrossFade(i,t=.25,e="repeat"){this.mixer.addEventListener("loop",(function n(a){s.resetActions(),a.action==s.lastAction&&(s.mixer.removeEventListener("loop",n),s.executeCrossFade(i,t,e))}));const s=this}onFinishActions(){this.mixer.addEventListener("finished",(()=>{if(this.died)return this.gameover();this.actions.some((i=>["slash","kick","backflip"].includes(i)))||this.executeCrossFade(this.returnAction),this.resetActions()}))}resetActions(){this.waitForAnimation=!1,this.isBackingflip=!1,this.isRolling=!1,this.isJumping=!1,this.beenHit=!1,this.isSlashing=!1,this.isKicking=!1,this.isHealing=!1,this.processingAttack=!1}initAudio(){for(let i=0;i<=4;i++)this.fetchAudio(`attack-${i}`,`./audio/hero/attack/${i}.mp3`),this.fetchAudio(`damage-${i}`,`./audio/hero/damage/${i}.mp3`);for(let i=0;i<=3;i++)this.fetchAudio(`slash-${i}`,`./audio/weapons/slash-${i}.mp3`);this.fetchAudio("heal","./audio/misc/drinking.mp3")}vibrate(i=100,t=.1){if(this.gamepad)this.gamepad.vibrationActuator.playEffect(this.gamepad.vibrationActuator.type,{startDelay:0,duration:t,weakMagnitude:i/1e3,strongMagnitude:i/500});else if(l.Z.isMobile)try{navigator.vibrate(i)}catch(i){}}toggleVisibility(){document.hidden&&this.actions.splice(0)}executeMelleeAttack(){if(!this.isSlashing)return;let i=this.hasHit(window.game.enemy);i&&Math.random()<=.75&&(window.game.enemy.setupDamage(10),this.playSlashSE()),this.processingAttack=!i}resizeScene(){this.refreshHPBar()}get returnAction(){return this.actions.some((i=>["walking","turningLeft","turningRight"].includes(i)))?this.animations.running:this.actions.includes("walkingBack")?this.animations.walkingBack:this.animations.idle}}e(399);const p=["aoMap","emissiveMap","displacementMap","map","normalMap","specularMap"],g=[],m=new s.dpR;class f{loadingElements=3;constructor(){this.lastFrameTime=performance.now(),this.camera=new s.cPb(75,window.innerWidth/window.innerHeight,.1,1e3),this.clock=new s.SUY,this.ambientLight=new s.Mig(16777215,.1),this.dirLight=new s.Ox3(16777215,.1),this.textureLoader=new s.dpR,this.scene=new s.xsS,this.fps=0,this.fpsLimit=0,this.frames=0,this.clockDelta=0,this.initRender(),this.refreshFPS(),this.refreshResolution(),this.refreshPixelDensity(),this.setupLoading(),document.body.appendChild(this.renderer.domElement)}initRender(){this.renderer=new s.CP7({alpha:!0}),this.renderer.outputColorSpace=s.KI_,this.renderer.shadowMap.enabled=!0,this.dirLight.position.set(0,100,100),this.dirLight.castShadow=!0,this.scene.add(this.ambientLight),this.scene.add(this.dirLight),this.scene.background=null,this.refreshAntialiasing()}refreshFPS(i=!0){let t=localStorage.getItem("fpsLimit");"60"==t?this.fpsLimit=1/60:"30"==t?this.fpsLimit=1/30:(this.fpsLimit=0,t=0),i&&window.refreshFPS(t,!1)}refreshResolution(i=!0,t=!1){let e=localStorage.getItem("resolution");"1"==e?(this.screenWidth=parseInt(window.innerWidth/4*3),this.screenHeight=parseInt(window.innerHeight/4*3)):"2"==e?(this.screenWidth=parseInt(window.innerWidth/2),this.screenHeight=parseInt(window.innerHeight/2)):(e=0,this.screenWidth=window.innerWidth,this.screenHeight=window.innerHeight),i&&window.refreshResolution(e,!1),t&&setTimeout((()=>this.resizeScene()),10)}refreshPixelDensity(i=!0){let t=localStorage.getItem("pixelDensity");"0"==t?this.pixelDensity=window.devicePixelRatio:"1"==t?this.pixelDensity=window.devicePixelRatio/4*3:"2"==t?this.pixelDensity=window.devicePixelRatio/2:l.Z.cpuCores>=4&&l.Z.memory>=6?(this.pixelDensity=window.devicePixelRatio,t=0):l.Z.cpuCores<4?(this.pixelDensity=window.devicePixelRatio/4*3,t=1):(this.pixelDensity=1,t=2),i&&window.refreshPixelDensity(t,!1)}refreshAntialiasing(i=!0){let t=localStorage.getItem("antialiasing");null==t&&l.Z.cpuCores>=4&&(t="true"),this.renderer.antialias="true"==t,i&&window.window.refreshAntialiasing("true"==t,!1)}setupLoading(){const i=this;this.progress=new Proxy({},{set:function(t,e,s){t[e]=s;let n=Object.values(t).slice(),a=document.querySelector("progress"),o=n.reduce(((i,t)=>i+t),0);return o/=i.loadingElements,a&&(a.value=parseInt(o||0)),o>=100&&i.initGame(),!0}}),this.loadModels()}loadModels(){(i=>{if(i.textures)return i.textures.forEach((t=>{p.includes(t.type)&&g.push(new Promise(((e,n)=>{m.load(`/textures/${t.texture}`,(n=>{n.materialType=t.type,n.colorSpace=s.KI_,n.wrapS=s.rpg,n.wrapT=s.rpg,i.repeat&&n.repeat.set(i.repeat,i.repeat),e(n)}),void 0,(i=>{n(i)}))})))})),new Promise(((t,e)=>{Promise.all(g).then((e=>{const n=new s.YBo;i.aoMapIntensity&&(n.aoMapIntensity=i.aoMapIntensity),i.emissiveIntensity&&(n.emissiveIntensity=i.emissiveIntensity),i.displacementScale&&(n.displacementScale=i.displacementScale),i.displacementBias&&(n.displacementBias=i.displacementBias),"object"==typeof i.normalScale&&(n.normalScale=new s.FM8(i.normalScale[0],i.normalScale[1])),"number"==typeof i.normalScale&&(n.normalScale=new s.FM8(i.normalScale,i.normalScale)),e.forEach((i=>{n[i.materialType]=i})),t(n)})).catch((i=>{e(i)}))}))})({repeat:10,aoMapIntensity:3,emissiveIntensity:3,displacementScale:1.5,displacementBias:-.15,normalScale:10,textures:[{type:"aoMap",texture:"GroundForestRoots001_AO_1K.webp"},{type:"emissiveMap",texture:"GroundForestRoots001_GLOSS_1K.webp"},{type:"displacementMap",texture:"GroundForestRoots001_DISP_1K.webp"},{type:"map",texture:"GroundForestRoots001_COL_1K.webp"},{type:"normalMap",texture:"GroundForestRoots001_NRM_1K.webp"},{type:"specularMap",texture:"GroundForestRoots001_REFL_1K.webp"}]}).then((i=>{const t=new s.Kj0(new s._12(200,200,200,200),i);t.rotation.x=-Math.PI/2,t.receiveShadow=!0,this.scene.add(t),this.progress.ground||(this.progress.ground=100)})),this.player=new u(this.camera,(i=>{this.scene.add(i),this.dirLight.target=i}),(i=>{this.progress.player=i})),this.enemy=new c(this.player,(i=>{this.scene.add(i)}),(i=>{this.progress.enemy=i}))}initGame(){this.initiated||(this.resizeScene(),this.update(),setTimeout((()=>{l.Z.isPC||document.querySelectorAll("footer").forEach((i=>i.style.removeProperty("display"))),document.querySelector("header").style.removeProperty("display"),document.body.removeChild(document.querySelector("#loading")),this.player.refreshHPBar()}),250),this.initiated=!0)}update(){this.animationFrameId=requestAnimationFrame((()=>this.update())),document.hidden||this.gameover||(this.clockDelta+=this.clock.getDelta(),this.fpsLimit&&this.clockDelta<this.fpsLimit||(this.renderer.render(this.scene,this.camera),this.player.update(this.clockDelta),this.paused||(this.updateFPSCounter(),this.enemy.update(this.clockDelta)),this.clockDelta=this.fpsLimit?this.clockDelta%this.fpsLimit:this.clockDelta%(1/Math.max(this.fps,30))))}initAudio(){this.player.initAudio(),this.enemy.initAudio()}updateFPSCounter(){if(this.frames++,!(performance.now()<this.lastFrameTime+1e3)){if(this.fps=Math.round(1e3*this.frames/(performance.now()-this.lastFrameTime)),!Number.isNaN(this.fps)){let i=document.querySelector("#fps").getContext("2d");i.font="bold 20px sans-serif",i.textAlign="end",i.textBaseline="middle",i.fillStyle="rgba(255,255,255,0.25)",i.clearRect(0,0,80,20),i.fillText(`${this.fps} FPS`,80,10)}this.lastFrameTime=performance.now(),this.frames=0}}resizeScene(){this.camera.updateProjectionMatrix(),this.renderer.setPixelRatio(this.pixelDensity),this.camera.aspect=this.screenWidth/this.screenHeight,this.renderer.setSize(this.screenWidth,this.screenHeight,!1),this.player.resizeScene(),this.enemy.resizeScene()}toggleVisibility(){this.player?.toggleVisibility(),this.enemy?.toggleVisibility()}togglePause(){this.paused=!this.paused,this.paused?document.querySelector("#glass").classList.add("opened"):document.querySelector("#glass").classList.remove("opened")}get delay(){return this.fpsLimit?100*this.fpsLimit:1}}},354:(i,t,e)=>{e.d(t,{$:()=>n});var s=e(479);class n{constructor(){this.initialized=!1,this.audio=new Audio,this.bgmVolume=.25,this.seVolume=1,this.guiSEs=["cursor","click","cancel"],this.ses=[]}init(){if(this.initialized)return;this.audioContext=new AudioContext,this.bgmGain=this.audioContext.createGain(),this.bgmGain.gain.value=this.bgmVolume,this.seGain=this.audioContext.createGain(),this.seGain.gain.value=this.seVolume;const i=this.audioContext.createMediaStreamDestination();this.bgmGain.connect(this.audioContext.destination),this.seGain.connect(this.audioContext.destination),this.audio.srcObject=i.stream,this.audio.play(),fetch("./audio/bgm/bgm.mp3",{cache:"force-cache"}).then((i=>{i.arrayBuffer().then((i=>{this.audioContext.decodeAudioData(i).then((i=>{this.bgmBuffer=i,this.playBGM()}))}))})),fetch("./audio/me/gameover.mp3",{cache:"force-cache"}).then((i=>{i.arrayBuffer().then((i=>{this.audioContext.decodeAudioData(i).then((i=>{this.gameoverBuffer=i}))}))})),this.guiSEs.forEach((i=>{fetch(`./audio/se/${i}.mp3`,{cache:"force-cache"}).then((t=>{t.arrayBuffer().then((t=>{this.audioContext.decodeAudioData(t).then((t=>{this.ses[i]=t}))}))}))}),this),this.audioListener=new s.SJI,this.audioListener.setMasterVolume(this.seVolume),window.game&&(window.game.camera.add(this.audioListener),window.game.initAudio()),this.initialized=!0}playBGM(i=!0){!window.game.gameover&&this.audioContext&&this.bgmBuffer&&(this.bgmSource=this.audioContext.createBufferSource(),this.bgmSource.buffer=this.bgmBuffer,this.bgmSource.loop=!0,this.bgmSource.connect(this.bgmGain),"false"!==localStorage.getItem("bgm")&&(i?this.bgmSource.start(0):this.bgmSource.start()),this.bgmSource.onended=()=>{this.bgmSource.disconnect(),this.bgmSource=void 0})}stopBGM(){try{this.bgmSource&&this.bgmSource.stop()}catch(i){}}playME(i){i&&(this.stopBGM(),this.meSource=this.audioContext.createBufferSource(),this.meSource.buffer=i,this.meSource.connect(this.bgmGain),this.bgmGain.gain.value=this.seVolume,this.meSource.start(0),this.meSource.onended=()=>{this.bgmGain.gain.value=document.hidden?0:this.bgmVolume,this.meSource?.disconnect(),this.meSource=void 0,this.playBGM(!1)})}playSE(i,t=!1,e){if(!this.audioContext||!i)return;const s=this.audioContext.createBufferSource();return s.buffer=i,s.loop=t,s.connect(this.seGain),s.start(0),s.onended=()=>{s.disconnect(),e&&(e.sePlaying=!1)},s}playClick(){this.playSE(this.ses.click)}playCursor(){this.playSE(this.ses.cursor)}playCancel(){this.playSE(this.ses.cancel)}toggleVisibility(){document.hidden?(this.bgmGain&&(this.bgmGain.gain.value=0),this.audioListener?.setMasterVolume(0)):(this.bgmGain&&(this.bgmGain.gain.value=this.bgmVolume),this.audioListener?.setMasterVolume(this.seVolume))}}}}]);