(self.webpackChunkhero=self.webpackChunkhero||[]).push([[19],{934:(e,t,n)=>{n.d(t,{Z:()=>o});const o={get name(){return/(iphone)/i.test(navigator.userAgent)?"iphone":/(ipad)/i.test(navigator.userAgent)?"ipad":/(android)/i.test(navigator.userAgent)?"android":/(windows)/i.test(navigator.userAgent)?"windows":/(linux|arch|ubuntu|mint|manjaro|debian)/i.test(navigator.userAgent)?"linux":/(mac|macos|macintosh)/i.test(navigator.userAgent)?"mac":null},get osVersion(){return/(iphone)/i.test(navigator.userAgent)?parseInt(/OS\s(\d+)_(\d+)_?(\d+)?/i.exec(navigator.userAgent)[1]||"0"):parseInt(/(?:linux|arch|ubuntu|mint|manjaro|debian|windows|android|mac)\s([\.\_\d]+)/i.exec(navigator.userAgent)[1]||"0")},get memory(){return navigator.deviceMemory??0},get cpuCores(){return navigator.hardwareConcurrency??0},get isMobile(){return/(iphone|ipad|android)/i.test(navigator.userAgent)},get isPC(){return!/(iphone|ipad|android)/i.test(navigator.userAgent)},get isApple(){return/(iphone|ipad|mac)/i.test(navigator.userAgent)},get isLocalhost(){return["127.0.0.1","localhost"].includes(location.hostname)}}},815:(e,t,n)=>{function o(e,t,n=!0){let o=Math.random()*(t-e+1)+e;return n?Math.floor(o):o}n.d(t,{Z:()=>o})},194:(e,t,n)=>{var o,r=n(934);function s(){document.hidden||"wakeLock"in navigator&&navigator.wakeLock.request("screen").then((e=>o=e))}window.menuConfigOpened=function(){return document.querySelector("#menu-config").classList.contains("opened")},window.toggleMenuConfig=function(e=!1){const t=document.querySelector("#menu-config");t.classList.toggle("opened"),t.classList.contains("opened")?window.sound.playClick():window.sound.playCancel(),e&&t.classList.contains("opened")?t.firstChild.classList.add("active"):t.childNodes.forEach((e=>e.classList.remove("active")))},window.navigateMenuConfig=function(e){const t=Array.from(document.querySelector("#menu-config").childNodes).filter((e=>!e.classList.contains("off"))),n=t.findIndex((e=>e.classList.contains("active")));let o;e>0&&n<t.length-1?o=n+1:e<0&&n>0&&(o=n-1),o>=0&&(window.sound.playCursor(),document.querySelector("#menu-config").childNodes.forEach((e=>e.classList.remove("active"))),t[o].classList.add("active"))},window.executeMenuConfig=function(e){if(e||(e=Array.from(document.querySelector("#menu-config").childNodes).find((e=>e.classList.contains("active"))).id),e.includes("music-on"))localStorage.setItem("bgm","true"),document.querySelector("#menu-button-music-on").classList.add("off"),document.querySelector("#menu-button-music-off").classList.remove("off"),document.querySelector("#menu-config").childNodes.forEach((e=>e.classList.remove("active"))),document.querySelector("#menu-config").childNodes[1].classList.add("active"),window.sound.playBGM();else if(e.includes("music-off"))localStorage.setItem("bgm","false"),document.querySelector("#menu-button-music-off").classList.add("off"),document.querySelector("#menu-button-music-on").classList.remove("off"),document.querySelector("#menu-config").childNodes.forEach((e=>e.classList.remove("active"))),document.querySelector("#menu-config").childNodes[0].classList.add("active"),window.sound.stopBGM();else if(e.includes("controls")){let e=document.querySelector("#dialog-controller");e.classList.toggle("opened"),e.classList.contains("opened")?window.sound.playClick():window.sound.playCancel()}else e.includes("fps")?(localStorage.getItem("fpsLimit")&&"0"!=localStorage.getItem("fpsLimit")?"60"==localStorage.getItem("fpsLimit")?window.refreshFPS(30):"30"==localStorage.getItem("fpsLimit")&&window.refreshFPS(0):window.refreshFPS(60),window.game.refreshFPS(!1)):e.includes("resolution")?(localStorage.getItem("resolution")&&"0"!=localStorage.getItem("resolution")?"1"==localStorage.getItem("resolution")?window.refreshResolution(2):"2"==localStorage.getItem("resolution")&&window.refreshResolution(0):window.refreshResolution(1),window.game.refreshResolution(!1),window.game.resizeScene()):e.includes("pixel_density")?(localStorage.getItem("pixelDensity")&&"0"!=localStorage.getItem("pixelDensity")?"1"==localStorage.getItem("pixelDensity")?window.refreshPixelDensity(2):"2"==localStorage.getItem("pixelDensity")&&window.refreshPixelDensity(0):window.refreshPixelDensity(1),window.game.refreshPixelDensity(),window.game.resizeScene()):e.includes("antialiasing")?("true"==localStorage.getItem("antialiasing")?window.refreshAntialiasing(!1):window.refreshAntialiasing(!0),window.game.refreshAntialiasing(!1)):e.includes("force_refresh")&&caches.delete("hero").then((()=>location.reload(!0)))},window.refreshFPS=function(e,t=!0){t&&("number"==typeof e?localStorage.setItem("fpsLimit",e.toString()):localStorage.removeItem("fpsLimit")),document.querySelector("#menu-button-fps label").innerHTML=`${e>0?e:"Auto"} FPS`},window.refreshResolution=function(e,t=!0){t&&("number"==typeof e?localStorage.setItem("resolution",e):localStorage.removeItem("resolution"));let n=(1==e?"Média":2==e?"Baixa":"Alta")+" resolução";document.querySelector("#menu-button-resolution label").innerHTML=n},window.refreshPixelDensity=function(e,t=!0){t&&("number"==typeof e?localStorage.setItem("pixelDensity",e.toString()):localStorage.removeItem("pixelDensity"));let n=(1==e?"Média":2==e?"Baixa":"Alta")+" densidade de pixels";document.querySelector("#menu-button-pixel_density label").innerHTML=n},window.refreshAntialiasing=function(e,t=!0){t&&("boolean"==typeof e?localStorage.setItem("antialiasing",e.toString()):localStorage.removeItem("antialiasing"));let n="Antialiasing "+(e?"ligado":"desligado");document.querySelector("#menu-button-antialiasing label").innerHTML=n,e?(document.querySelector("#antialiasing-on").style.removeProperty("display"),document.querySelector("#antialiasing-off").style.setProperty("display","none")):(document.querySelector("#antialiasing-on").style.setProperty("display","none"),document.querySelector("#antialiasing-off").style.removeProperty("display"))},window.refreshControlsMenu=()=>{window.game?.player?.gamepadConnected||r.Z.isPC?document.querySelector("#menu-button-controls").style.removeProperty("display"):document.querySelector("#menu-button-controls").style.setProperty("display","none"),window.game?.player?.gamepadConnected?(document.querySelectorAll("#gamepad")?.forEach((e=>e.style.removeProperty("display"))),document.querySelectorAll("#keyboard")?.forEach((e=>e.style.setProperty("display","none")))):(document.querySelectorAll("#gamepad")?.forEach((e=>e.style.setProperty("display","none"))),document.querySelectorAll("#keyboard")?.forEach((e=>e.style.removeProperty("display"))))},document.onclick=()=>{document.querySelector("#menu-config").classList.remove("opened"),window.sound.initialized||window.sound.init()},document.onvisibilitychange=()=>{window.game?.toggleVisibility(),window.sound?.toggleVisibility(),document.hidden?(document.querySelectorAll("footer section button").forEach((e=>{e.classList.remove("active")})),o&&o.release()):s()},document.onreadystatechange=()=>{"complete"==document.readyState&&("false"==localStorage.getItem("bgm")&&(document.querySelector("#menu-button-music-on").classList.remove("off"),document.querySelector("#menu-button-music-off").classList.add("off")),document.querySelector("#button-config").onclick=e=>{e.stopPropagation(),window.toggleMenuConfig()},document.querySelector("#menu-button-music-off").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("music-off")},document.querySelector("#menu-button-music-on").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("music-on")},document.querySelector("#menu-button-controls").onclick=e=>{window.executeMenuConfig("controls")},document.querySelector("#dialog-controller button").onclick=e=>{document.querySelector("#dialog-controller").classList.remove("opened")},document.querySelector("#menu-button-fps").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("fps")},document.querySelector("#menu-button-resolution").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("resolution")},document.querySelector("#menu-button-pixel_density").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("pixel_density")},document.querySelector("#menu-button-antialiasing").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("antialiasing")},document.querySelector("#menu-button-force_refresh").onclick=e=>{e.stopPropagation(),window.executeMenuConfig("force_refresh")},window.refreshControlsMenu())},window.oncontextmenu=e=>(e.preventDefault(),!1),window.onresize=()=>{window.game?.refreshResolution(!1,!0)},"screen"in window&&(screen.orientation.onchange=()=>{window.game?.refreshResolution(!1,!0)}),s();var i=n(354),a=n(598);if(window.sound=new i.$,window.game=new a.l,location.protocol.startsWith("https")){var l=!1;navigator.serviceWorker.register("service-worker.js").then((e=>{e.onupdatefound=()=>{console.info("SW update found."),l=!0},e.installing?console.info("SW installing..."):e.active&&l&&(console.info("SW updated. Reloading..."),location.reload())}))}},271:(e,t,n)=>{n.d(t,{Vs:()=>r});var o=n(479);function r(e,t){if(t===o.WwZ)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===o.z$h||t===o.UlW){let n=e.getIndex();if(null===n){const t=[],o=e.getAttribute("position");if(void 0===o)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<o.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const r=n.count-2,s=[];if(t===o.z$h)for(let e=1;e<=r;e++)s.push(n.getX(0)),s.push(n.getX(e)),s.push(n.getX(e+1));else for(let e=0;e<r;e++)e%2==0?(s.push(n.getX(e)),s.push(n.getX(e+1)),s.push(n.getX(e+2))):(s.push(n.getX(e+2)),s.push(n.getX(e+1)),s.push(n.getX(e)));s.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=e.clone();return i.setIndex(s),i.clearGroups(),i}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}},944:(e,t,n)=>{n.d(t,{k:()=>r});var o=n(479);class r extends o.u9r{constructor(e,t,n,r){super();const i=[],a=[],l=[],c=new o.Pa4,u=new o.yGw;u.makeRotationFromEuler(n),u.setPosition(t);const p=new o.yGw;function d(t,n,o){n.applyMatrix4(e.matrixWorld),n.applyMatrix4(p),o.transformDirection(e.matrixWorld),t.push(new s(n.clone(),o.clone()))}function h(e,t){const n=[],o=.5*Math.abs(r.dot(t));for(let r=0;r<e.length;r+=3){let s,i,a,l,c=0;const u=e[r+0].position.dot(t)-o>0,p=e[r+1].position.dot(t)-o>0,d=e[r+2].position.dot(t)-o>0;switch(c=(u?1:0)+(p?1:0)+(d?1:0),c){case 0:n.push(e[r]),n.push(e[r+1]),n.push(e[r+2]);break;case 1:if(u&&(s=e[r+1],i=e[r+2],a=m(e[r],s,t,o),l=m(e[r],i,t,o)),p){s=e[r],i=e[r+2],a=m(e[r+1],s,t,o),l=m(e[r+1],i,t,o),n.push(a),n.push(i.clone()),n.push(s.clone()),n.push(i.clone()),n.push(a.clone()),n.push(l);break}d&&(s=e[r],i=e[r+1],a=m(e[r+2],s,t,o),l=m(e[r+2],i,t,o)),n.push(s.clone()),n.push(i.clone()),n.push(a),n.push(l),n.push(a.clone()),n.push(i.clone());break;case 2:u||(s=e[r].clone(),i=m(s,e[r+1],t,o),a=m(s,e[r+2],t,o),n.push(s),n.push(i),n.push(a)),p||(s=e[r+1].clone(),i=m(s,e[r+2],t,o),a=m(s,e[r],t,o),n.push(s),n.push(i),n.push(a)),d||(s=e[r+2].clone(),i=m(s,e[r],t,o),a=m(s,e[r+1],t,o),n.push(s),n.push(i),n.push(a))}}return n}function m(e,t,n,r){const i=e.position.dot(n)-r,a=i/(i-(t.position.dot(n)-r));return new s(new o.Pa4(e.position.x+a*(t.position.x-e.position.x),e.position.y+a*(t.position.y-e.position.y),e.position.z+a*(t.position.z-e.position.z)),new o.Pa4(e.normal.x+a*(t.normal.x-e.normal.x),e.normal.y+a*(t.normal.y-e.normal.y),e.normal.z+a*(t.normal.z-e.normal.z)))}p.copy(u).invert(),function(){let t=[];const n=new o.Pa4,s=new o.Pa4,p=e.geometry,m=p.attributes.position,f=p.attributes.normal;if(null!==p.index){const e=p.index;for(let o=0;o<e.count;o++)n.fromBufferAttribute(m,e.getX(o)),s.fromBufferAttribute(f,e.getX(o)),d(t,n,s)}else for(let e=0;e<m.count;e++)n.fromBufferAttribute(m,e),s.fromBufferAttribute(f,e),d(t,n,s);t=h(t,c.set(1,0,0)),t=h(t,c.set(-1,0,0)),t=h(t,c.set(0,1,0)),t=h(t,c.set(0,-1,0)),t=h(t,c.set(0,0,1)),t=h(t,c.set(0,0,-1));for(let e=0;e<t.length;e++){const n=t[e];l.push(.5+n.position.x/r.x,.5+n.position.y/r.y),n.position.applyMatrix4(u),i.push(n.position.x,n.position.y,n.position.z),a.push(n.normal.x,n.normal.y,n.normal.z)}}(),this.setAttribute("position",new o.a$l(i,3)),this.setAttribute("normal",new o.a$l(a,3)),this.setAttribute("uv",new o.a$l(l,2))}}class s{constructor(e,t){this.position=e,this.normal=t}clone(){return new this.constructor(this.position.clone(),this.normal.clone())}}},527:(e,t,n)=>{n.d(t,{y:()=>c});var o=n(479),r=n(464),s=n(702);let i,a,l;class c extends o.aNw{constructor(e){super(e)}load(e,t,n,r){const s=this,i=""===s.path?o.Zp0.extractUrlBase(e):s.path,a=new o.hH6(this.manager);a.setPath(s.path),a.setResponseType("arraybuffer"),a.setRequestHeader(s.requestHeader),a.setWithCredentials(s.withCredentials),a.load(e,(function(n){try{t(s.parse(n,i))}catch(t){r?r(t):console.error(t),s.manager.itemError(e)}}),n,r)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===L(e,0,t.length)}(e))i=(new m).parse(e);else{const t=L(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function o(t){const o=e[t-1];return e=e.slice(n+t),n++,o}for(let e=0;e<t.length;++e){if(o(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(y(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+y(t));i=(new h).parse(t)}const n=new o.dpR(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new u(n,this.manager).parse(i)}}class u{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){a=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),o=this.parseDeformers(),r=(new p).parse(o);return this.parseScene(o,r,n),l}parseConnections(){const e=new Map;if("Connections"in i){i.Connections.connections.forEach((function(t){const n=t[0],o=t[1],r=t[2];e.has(n)||e.set(n,{parents:[],children:[]});const s={ID:o,relationship:r};e.get(n).parents.push(s),e.has(o)||e.set(o,{parents:[],children:[]});const i={ID:n,relationship:r};e.get(o).children.push(i)}))}return e}parseImages(){const e={},t={};if("Video"in i.Objects){const n=i.Objects.Video;for(const o in n){const r=n[o];if(e[parseInt(o)]=r.RelativeFilename||r.Filename,"Content"in r){const e=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,s="string"==typeof r.Content&&""!==r.Content;if(e||s){const e=this.parseImage(n[o]);t[r.RelativeFilename||r.Filename]=e}}}}for(const n in e){const o=e[n];void 0!==t[o]?e[n]=t[o]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,o=n.slice(n.lastIndexOf(".")+1).toLowerCase();let r;switch(o){case"bmp":r="image/bmp";break;case"jpg":case"jpeg":r="image/jpeg";break;case"png":r="image/png";break;case"tif":r="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",n),r="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+o+'" is not supported.')}if("string"==typeof t)return"data:"+r+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:r}))}}parseTextures(e){const t=new Map;if("Texture"in i.Objects){const n=i.Objects.Texture;for(const o in n){const r=this.parseTexture(n[o],e);t.set(parseInt(o),r)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const r=e.WrapModeU,s=e.WrapModeV,i=void 0!==r?r.value:0,a=void 0!==s?s.value:0;if(n.wrapS=0===i?o.rpg:o.uWy,n.wrapT=0===a?o.rpg:o.uWy,"Scaling"in e){const t=e.Scaling.value;n.repeat.x=t[0],n.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;n.offset.x=t[0],n.offset.y=t[1]}return n}loadTexture(e,t){let n;const r=this.textureLoader.path,s=a.get(e.id).children;let i;void 0!==s&&s.length>0&&void 0!==t[s[0].ID]&&(n=t[s[0].ID],0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));const l=e.FileName.slice(-3).toLowerCase();if("tga"===l){const t=this.manager.getHandler(".tga");null===t?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),i=new o.xEZ):(t.setPath(this.textureLoader.path),i=t.load(n))}else"psd"===l?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),i=new o.xEZ):i=this.textureLoader.load(n);return this.textureLoader.setPath(r),i}parseMaterials(e){const t=new Map;if("Material"in i.Objects){const n=i.Objects.Material;for(const o in n){const r=this.parseMaterial(n[o],e);null!==r&&t.set(parseInt(o),r)}}return t}parseMaterial(e,t){const n=e.id,r=e.attrName;let s=e.ShadingModel;if("object"==typeof s&&(s=s.value),!a.has(n))return null;const i=this.parseParameters(e,t,n);let l;switch(s.toLowerCase()){case"phong":l=new o.xoR;break;case"lambert":l=new o.YBo;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',s),l=new o.xoR}return l.setValues(i),l.name=r,l}parseParameters(e,t,n){const r={};e.BumpFactor&&(r.bumpScale=e.BumpFactor.value),e.Diffuse?r.color=(new o.Ilk).fromArray(e.Diffuse.value).convertSRGBToLinear():!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(r.color=(new o.Ilk).fromArray(e.DiffuseColor.value).convertSRGBToLinear()),e.DisplacementFactor&&(r.displacementScale=e.DisplacementFactor.value),e.Emissive?r.emissive=(new o.Ilk).fromArray(e.Emissive.value).convertSRGBToLinear():!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(r.emissive=(new o.Ilk).fromArray(e.EmissiveColor.value).convertSRGBToLinear()),e.EmissiveFactor&&(r.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(r.opacity=parseFloat(e.Opacity.value)),r.opacity<1&&(r.transparent=!0),e.ReflectionFactor&&(r.reflectivity=e.ReflectionFactor.value),e.Shininess&&(r.shininess=e.Shininess.value),e.Specular?r.specular=(new o.Ilk).fromArray(e.Specular.value).convertSRGBToLinear():e.SpecularColor&&"Color"===e.SpecularColor.type&&(r.specular=(new o.Ilk).fromArray(e.SpecularColor.value).convertSRGBToLinear());const s=this;return a.get(n).children.forEach((function(e){const n=e.relationship;switch(n){case"Bump":r.bumpMap=s.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":r.aoMap=s.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":r.map=s.getTexture(t,e.ID),void 0!==r.map&&(r.map.colorSpace=o.KI_);break;case"DisplacementColor":r.displacementMap=s.getTexture(t,e.ID);break;case"EmissiveColor":r.emissiveMap=s.getTexture(t,e.ID),void 0!==r.emissiveMap&&(r.emissiveMap.colorSpace=o.KI_);break;case"NormalMap":case"Maya|TEX_normal_map":r.normalMap=s.getTexture(t,e.ID);break;case"ReflectionColor":r.envMap=s.getTexture(t,e.ID),void 0!==r.envMap&&(r.envMap.mapping=o.dSO,r.envMap.colorSpace=o.KI_);break;case"SpecularColor":r.specularMap=s.getTexture(t,e.ID),void 0!==r.specularMap&&(r.specularMap.colorSpace=o.KI_);break;case"TransparentColor":case"TransparencyFactor":r.alphaMap=s.getTexture(t,e.ID),r.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",n)}})),r}getTexture(e,t){return"LayeredTexture"in i.Objects&&t in i.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=a.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in i.Objects){const n=i.Objects.Deformer;for(const o in n){const r=n[o],s=a.get(parseInt(o));if("Skin"===r.attrType){const t=this.parseSkeleton(s,n);t.ID=o,s.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=s.parents[0].ID,e[o]=t}else if("BlendShape"===r.attrType){const e={id:o};e.rawTargets=this.parseMorphTargets(s,n),e.id=o,s.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[o]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach((function(e){const r=t[e.ID];if("Cluster"!==r.attrType)return;const s={ID:e.ID,indices:[],weights:[],transformLink:(new o.yGw).fromArray(r.TransformLink.a)};"Indexes"in r&&(s.indices=r.Indexes.a,s.weights=r.Weights.a),n.push(s)})),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let o=0;o<e.children.length;o++){const r=e.children[o],s=t[r.ID],i={name:s.attrName,initialWeight:s.DeformPercent,id:s.id,fullWeights:s.FullWeights.a};if("BlendShapeChannel"!==s.attrType)return;i.geoID=a.get(parseInt(r.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(i)}return n}parseScene(e,t,n){l=new o.ZAu;const r=this.parseModels(e.skeletons,t,n),s=i.Objects.Model,c=this;r.forEach((function(e){const t=s[e.ID];c.setLookAtProperties(e,t);a.get(e.ID).parents.forEach((function(t){const n=r.get(t.ID);void 0!==n&&n.add(e)})),null===e.parent&&l.add(e)})),this.bindSkeleton(e.skeletons,t,r),this.createAmbientLight(),l.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=T(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const u=(new d).parse();1===l.children.length&&l.children[0].isGroup&&(l.children[0].animations=u,l=l.children[0]),l.animations=u}parseModels(e,t,n){const r=new Map,s=i.Objects.Model;for(const i in s){const l=parseInt(i),c=s[i],u=a.get(l);let p=this.buildSkeleton(u,e,l,c.attrName);if(!p){switch(c.attrType){case"Camera":p=this.createCamera(u);break;case"Light":p=this.createLight(u);break;case"Mesh":p=this.createMesh(u,t,n);break;case"NurbsCurve":p=this.createCurve(u,t);break;case"LimbNode":case"Root":p=new o.N$j;break;default:p=new o.ZAu}p.name=c.attrName?o.iUV.sanitizeNodeName(c.attrName):"",p.ID=l}this.getTransformData(p,c),r.set(l,p)}return r}buildSkeleton(e,t,n,r){let s=null;return e.parents.forEach((function(e){for(const i in t){const a=t[i];a.rawBones.forEach((function(t,i){if(t.ID===e.ID){const e=s;s=new o.N$j,s.matrixWorld.copy(t.transformLink),s.name=r?o.iUV.sanitizeNodeName(r):"",s.ID=n,a.bones[i]=s,null!==e&&s.add(e)}}))}})),s}createCamera(e){let t,n;if(e.children.forEach((function(e){const t=i.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new o.Tme;else{let e=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(e=1);let r=1;void 0!==n.NearPlane&&(r=n.NearPlane.value/1e3);let s=1e3;void 0!==n.FarPlane&&(s=n.FarPlane.value/1e3);let i=window.innerWidth,a=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(i=n.AspectWidth.value,a=n.AspectHeight.value);const l=i/a;let c=45;void 0!==n.FieldOfView&&(c=n.FieldOfView.value);const u=n.FocalLength?n.FocalLength.value:null;switch(e){case 0:t=new o.cPb(c,l,r,s),null!==u&&t.setFocalLength(u);break;case 1:t=new o.iKG(-i/2,i/2,a/2,-a/2,r,s);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new o.Tme}}return t}createLight(e){let t,n;if(e.children.forEach((function(e){const t=i.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new o.Tme;else{let e;e=void 0===n.LightType?0:n.LightType.value;let r=16777215;void 0!==n.Color&&(r=(new o.Ilk).fromArray(n.Color.value).convertSRGBToLinear());let s=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(s=0);let i=0;void 0!==n.FarAttenuationEnd&&(i=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);const a=1;switch(e){case 0:t=new o.cek(r,s,i,a);break;case 1:t=new o.Ox3(r,s);break;case 2:let e=Math.PI/3;void 0!==n.InnerAngle&&(e=o.M8C.degToRad(n.InnerAngle.value));let l=0;void 0!==n.OuterAngle&&(l=o.M8C.degToRad(n.OuterAngle.value),l=Math.max(l,1)),t=new o.PMe(r,s,i,e,l,a);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new o.cek(r,s)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,n){let r,s=null,i=null;const a=[];return e.children.forEach((function(e){t.has(e.ID)&&(s=t.get(e.ID)),n.has(e.ID)&&a.push(n.get(e.ID))})),a.length>1?i=a:a.length>0?i=a[0]:(i=new o.xoR({name:o.aNw.DEFAULT_MATERIAL_NAME,color:13421772}),a.push(i)),"color"in s.attributes&&a.forEach((function(e){e.vertexColors=!0})),s.FBX_Deformer?(r=new o.TUv(s,i),r.normalizeSkinWeights()):r=new o.Kj0(s,i),r}createCurve(e,t){const n=e.children.reduce((function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e}),null),r=new o.nls({name:o.aNw.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new o.x12(n,r)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder="RotationOrder"in t?S(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){if("LookAtProperty"in t){a.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const n=i.Objects.Model[t.ID];if("Lcl_Translation"in n){const t=n.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),l.add(e.target)):e.lookAt((new o.Pa4).fromArray(t))}}}))}}bindSkeleton(e,t,n){const r=this.parsePoseNodes();for(const s in e){const i=e[s];a.get(parseInt(i.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;a.get(t).parents.forEach((function(e){if(n.has(e.ID)){n.get(e.ID).bind(new o.OdW(i.bones),r[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in i.Objects){const t=i.Objects.Pose;for(const n in t)if("BindPose"===t[n].attrType&&t[n].NbPoseNodes>0){const r=t[n].PoseNode;Array.isArray(r)?r.forEach((function(t){e[t.Node]=(new o.yGw).fromArray(t.Matrix.a)})):e[r.Node]=(new o.yGw).fromArray(r.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in i&&"AmbientColor"in i.GlobalSettings){const e=i.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],r=e[2];if(0!==t||0!==n||0!==r){const e=new o.Ilk(t,n,r).convertSRGBToLinear();l.add(new o.Mig(e,1))}}}}class p{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in i.Objects){const n=i.Objects.Geometry;for(const o in n){const r=a.get(parseInt(o)),s=this.parseGeometry(r,n[o],e);t.set(parseInt(o),s)}}return!0===this.negativeMaterialIndices&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const o=n.skeletons,r=[],s=e.parents.map((function(e){return i.Objects.Model[e.ID]}));if(0===s.length)return;const a=e.children.reduce((function(e,t){return void 0!==o[t.ID]&&(e=o[t.ID]),e}),null);e.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&r.push(n.morphTargets[e.ID])}));const l=s[0],c={};"RotationOrder"in l&&(c.eulerOrder=S(l.RotationOrder.value)),"InheritType"in l&&(c.inheritType=parseInt(l.InheritType.value)),"GeometricTranslation"in l&&(c.translation=l.GeometricTranslation.value),"GeometricRotation"in l&&(c.rotation=l.GeometricRotation.value),"GeometricScaling"in l&&(c.scale=l.GeometricScaling.value);const u=T(c);return this.genGeometry(t,a,r,u)}genGeometry(e,t,n,r){const s=new o.u9r;e.attrName&&(s.name=e.attrName);const i=this.parseGeoNode(e,t),a=this.genBuffers(i),l=new o.a$l(a.vertex,3);if(l.applyMatrix4(r),s.setAttribute("position",l),a.colors.length>0&&s.setAttribute("color",new o.a$l(a.colors,3)),t&&(s.setAttribute("skinIndex",new o.qlB(a.weightsIndices,4)),s.setAttribute("skinWeight",new o.a$l(a.vertexWeights,4)),s.FBX_Deformer=t),a.normal.length>0){const e=(new o.Vkp).getNormalMatrix(r),t=new o.a$l(a.normal,3);t.applyNormalMatrix(e),s.setAttribute("normal",t)}if(a.uvs.forEach((function(e,t){const n=0===t?"uv":`uv${t}`;s.setAttribute(n,new o.a$l(a.uvs[t],2))})),i.material&&"AllSame"!==i.material.mappingType){let e=a.materialIndex[0],t=0;if(a.materialIndex.forEach((function(n,o){n!==e&&(s.addGroup(t,o-t,e),e=n,t=o)})),s.groups.length>0){const t=s.groups[s.groups.length-1],n=t.start+t.count;n!==a.materialIndex.length&&s.addGroup(n,a.materialIndex.length-n,e)}0===s.groups.length&&s.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(s,e,n,r),s}parseGeoNode(e,t){const n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(o,r){void 0===n.weightTable[o]&&(n.weightTable[o]=[]),n.weightTable[o].push({id:t,weight:e.weights[r]})}))}))),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,o=0,r=!1,s=[],i=[],a=[],l=[],c=[],u=[];const p=this;return e.vertexIndices.forEach((function(d,h){let m,f=!1;d<0&&(d^=-1,f=!0);let g=[],y=[];if(s.push(3*d,3*d+1,3*d+2),e.color){const t=I(h,n,d,e.color);a.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){y.push(e.weight),g.push(e.id)})),y.length>4){r||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),r=!0);const e=[0,0,0,0],t=[0,0,0,0];y.forEach((function(n,o){let r=n,s=g[o];t.forEach((function(t,n,o){if(r>t){o[n]=r,r=t;const i=e[n];e[n]=s,s=i}}))})),g=e,y=t}for(;y.length<4;)y.push(0),g.push(0);for(let e=0;e<4;++e)c.push(y[e]),u.push(g[e])}if(e.normal){const t=I(h,n,d,e.normal);i.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(m=I(h,n,d,e.material)[0],m<0&&(p.negativeMaterialIndices=!0,m=0)),e.uv&&e.uv.forEach((function(e,t){const o=I(h,n,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(o[0]),l[t].push(o[1])})),o++,f&&(o>4&&console.warn("THREE.FBXLoader: Polygons with more than four sides are not supported. Make sure to triangulate the geometry during export."),p.genFace(t,e,s,m,i,a,l,c,u,o),n++,o=0,s=[],i=[],a=[],l=[],c=[],u=[])})),t}genFace(e,t,n,o,r,s,i,a,l,c){for(let u=2;u<c;u++)e.vertex.push(t.vertexPositions[n[0]]),e.vertex.push(t.vertexPositions[n[1]]),e.vertex.push(t.vertexPositions[n[2]]),e.vertex.push(t.vertexPositions[n[3*(u-1)]]),e.vertex.push(t.vertexPositions[n[3*(u-1)+1]]),e.vertex.push(t.vertexPositions[n[3*(u-1)+2]]),e.vertex.push(t.vertexPositions[n[3*u]]),e.vertex.push(t.vertexPositions[n[3*u+1]]),e.vertex.push(t.vertexPositions[n[3*u+2]]),t.skeleton&&(e.vertexWeights.push(a[0]),e.vertexWeights.push(a[1]),e.vertexWeights.push(a[2]),e.vertexWeights.push(a[3]),e.vertexWeights.push(a[4*(u-1)]),e.vertexWeights.push(a[4*(u-1)+1]),e.vertexWeights.push(a[4*(u-1)+2]),e.vertexWeights.push(a[4*(u-1)+3]),e.vertexWeights.push(a[4*u]),e.vertexWeights.push(a[4*u+1]),e.vertexWeights.push(a[4*u+2]),e.vertexWeights.push(a[4*u+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(u-1)]),e.weightsIndices.push(l[4*(u-1)+1]),e.weightsIndices.push(l[4*(u-1)+2]),e.weightsIndices.push(l[4*(u-1)+3]),e.weightsIndices.push(l[4*u]),e.weightsIndices.push(l[4*u+1]),e.weightsIndices.push(l[4*u+2]),e.weightsIndices.push(l[4*u+3])),t.color&&(e.colors.push(s[0]),e.colors.push(s[1]),e.colors.push(s[2]),e.colors.push(s[3*(u-1)]),e.colors.push(s[3*(u-1)+1]),e.colors.push(s[3*(u-1)+2]),e.colors.push(s[3*u]),e.colors.push(s[3*u+1]),e.colors.push(s[3*u+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(o),e.materialIndex.push(o),e.materialIndex.push(o)),t.normal&&(e.normal.push(r[0]),e.normal.push(r[1]),e.normal.push(r[2]),e.normal.push(r[3*(u-1)]),e.normal.push(r[3*(u-1)+1]),e.normal.push(r[3*(u-1)+2]),e.normal.push(r[3*u]),e.normal.push(r[3*u+1]),e.normal.push(r[3*u+2])),t.uv&&t.uv.forEach((function(t,n){void 0===e.uvs[n]&&(e.uvs[n]=[]),e.uvs[n].push(i[n][0]),e.uvs[n].push(i[n][1]),e.uvs[n].push(i[n][2*(u-1)]),e.uvs[n].push(i[n][2*(u-1)+1]),e.uvs[n].push(i[n][2*u]),e.uvs[n].push(i[n][2*u+1])}))}addMorphTargets(e,t,n,o){if(0===n.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;n.forEach((function(n){n.rawTargets.forEach((function(n){const s=i.Objects.Geometry[n.geoID];void 0!==s&&r.genMorphGeometry(e,t,s,o,n.name)}))}))}genMorphGeometry(e,t,n,r,s){const i=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],a=void 0!==n.Vertices?n.Vertices.a:[],l=void 0!==n.Indexes?n.Indexes.a:[],c=3*e.attributes.position.count,u=new Float32Array(c);for(let e=0;e<l.length;e++){const t=3*l[e];u[t]=a[3*e],u[t+1]=a[3*e+1],u[t+2]=a[3*e+2]}const p={vertexIndices:i,vertexPositions:u},d=this.genBuffers(p),h=new o.a$l(d.vertex,3);h.name=s||n.attrName,h.applyMatrix4(r),e.morphAttributes.position.push(h)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,o=e.Normals.a;let r=[];return"IndexToDirect"===n&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:o,indices:r,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,o=e.UV.a;let r=[];return"IndexToDirect"===n&&(r=e.UVIndex.a),{dataSize:2,buffer:o,indices:r,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.Colors.a;let s=[];"IndexToDirect"===n&&(s=e.ColorIndex.a);for(let e=0,t=new o.Ilk;e<r.length;e+=4)t.fromArray(r,e).convertSRGBToLinear().toArray(r,e);return{dataSize:4,buffer:r,indices:s,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const o=e.Materials.a,r=[];for(let e=0;e<o.length;++e)r.push(e);return{dataSize:1,buffer:o,indices:r,mappingType:t,referenceType:n}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new o.u9r;const n=t-1,r=e.KnotVector.a,i=[],a=e.Points.a;for(let e=0,t=a.length;e<t;e+=4)i.push((new o.Ltg).fromArray(a,e));let l,c;if("Closed"===e.Form)i.push(i[0]);else if("Periodic"===e.Form){l=n,c=r.length-1-l;for(let e=0;e<n;++e)i.push(i[e])}const u=new s.e(n,r,i,l,c).getPoints(12*i.length);return(new o.u9r).setFromPoints(u)}}class d{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const n in t){const o=t[n],r=this.addClip(o);e.push(r)}return e}parseClips(){if(void 0===i.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=i.Objects.AnimationCurveNode,t=new Map;for(const n in e){const o=e[n];if(null!==o.attrName.match(/S|R|T|DeformPercent/)){const e={id:o.id,attr:o.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=i.Objects.AnimationCurve;for(const n in t){const o={id:t[n].id,times:t[n].KeyTime.a.map(v),values:t[n].KeyValueFloat.a},r=a.get(o.id);if(void 0!==r){const t=r.parents[0].ID,n=r.parents[0].relationship;n.match(/X/)?e.get(t).curves.x=o:n.match(/Y/)?e.get(t).curves.y=o:n.match(/Z/)?e.get(t).curves.z=o:n.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=o)}}}parseAnimationLayers(e){const t=i.Objects.AnimationLayer,n=new Map;for(const r in t){const t=[],s=a.get(parseInt(r));if(void 0!==s){s.children.forEach((function(n,r){if(e.has(n.ID)){const s=e.get(n.ID);if(void 0!==s.curves.x||void 0!==s.curves.y||void 0!==s.curves.z){if(void 0===t[r]){const e=a.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const s=i.Objects.Model[e.toString()];if(void 0===s)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",n);const a={modelName:s.attrName?o.iUV.sanitizeNodeName(s.attrName):"",ID:s.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};l.traverse((function(e){e.ID===s.id&&(a.transform=e.matrix,e.userData.transformData&&(a.eulerOrder=e.userData.transformData.eulerOrder))})),a.transform||(a.transform=new o.yGw),"PreRotation"in s&&(a.preRotation=s.PreRotation.value),"PostRotation"in s&&(a.postRotation=s.PostRotation.value),t[r]=a}}t[r]&&(t[r][s.attr]=s)}else if(void 0!==s.curves.morph){if(void 0===t[r]){const e=a.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,s=a.get(e).parents[0].ID,l=a.get(s).parents[0].ID,c=a.get(l).parents[0].ID,u=i.Objects.Model[c],p={modelName:u.attrName?o.iUV.sanitizeNodeName(u.attrName):"",morphName:i.Objects.Deformer[e].attrName};t[r]=p}t[r][s.attr]=s}}})),n.set(parseInt(r),t)}}return n}parseAnimStacks(e){const t=i.Objects.AnimationStack,n={};for(const o in t){const r=a.get(parseInt(o)).children;r.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const s=e.get(r[0].ID);n[o]={name:t[o].attrName,layer:s}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach((function(e){t=t.concat(n.generateTracks(e))})),new o.m7l(e.name,-1,t)}generateTracks(e){const t=[];let n=new o.Pa4,r=new o._fP,s=new o.Pa4;if(e.transform&&e.transform.decompose(n,r,s),n=n.toArray(),r=(new o.USm).setFromQuaternion(r,e.eulerOrder).toArray(),s=s.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==o&&t.push(o)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const n=this.generateRotationTrack(e.modelName,e.R.curves,r,e.preRotation,e.postRotation,e.eulerOrder);void 0!==n&&t.push(n)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const n=this.generateVectorTrack(e.modelName,e.S.curves,s,"scale");void 0!==n&&t.push(n)}if(void 0!==e.DeformPercent){const n=this.generateMorphTrack(e);void 0!==n&&t.push(n)}return t}generateVectorTrack(e,t,n,r){const s=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(s,t,n);return new o.yC1(e+"."+r,s,i)}generateRotationTrack(e,t,n,r,s,i){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(o.M8C.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(o.M8C.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(o.M8C.degToRad));const a=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(a,t,n);void 0!==r&&((r=r.map(o.M8C.degToRad)).push(i),r=(new o.USm).fromArray(r),r=(new o._fP).setFromEuler(r)),void 0!==s&&((s=s.map(o.M8C.degToRad)).push(i),s=(new o.USm).fromArray(s),s=(new o._fP).setFromEuler(s).invert());const c=new o._fP,u=new o.USm,p=[];for(let e=0;e<l.length;e+=3)u.set(l[e],l[e+1],l[e+2],i),c.setFromEuler(u),void 0!==r&&c.premultiply(r),void 0!==s&&c.multiply(s),c.toArray(p,e/3*4);return new o.iLg(e+".quaternion",a,p)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),r=l.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new o.dUE(e.modelName+".morphTargetInfluences["+r+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,n=t[0];for(let o=1;o<t.length;o++){const r=t[o];r!==n&&(t[e]=r,n=r,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,n){const o=n,r=[];let s=-1,i=-1,a=-1;return e.forEach((function(e){if(t.x&&(s=t.x.times.indexOf(e)),t.y&&(i=t.y.times.indexOf(e)),t.z&&(a=t.z.times.indexOf(e)),-1!==s){const e=t.x.values[s];r.push(e),o[0]=e}else r.push(o[0]);if(-1!==i){const e=t.y.values[i];r.push(e),o[1]=e}else r.push(o[1]);if(-1!==a){const e=t.z.values[a];r.push(e),o[2]=e}else r.push(o[2])})),r}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const n=e.values[t-1],o=e.values[t]-n,r=Math.abs(o);if(r>=180){const s=r/180,i=o/s;let a=n+i;const l=e.times[t-1],c=(e.times[t]-l)/s;let u=l+c;const p=[],d=[];for(;u<e.times[t];)p.push(u),u+=c,d.push(a),a+=i;e.times=P(e.times,t,p),e.values=P(e.values,t,d)}}}}class h{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new g,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach((function(e,o){const r=e.match(/^[\s\t]*;/),s=e.match(/^[\s\t]*$/);if(r||s)return;const i=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),a=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");i?t.parseNodeBegin(e,i):a?t.parseNodeProperty(e,a,n[++o]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),o=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),r={name:n},s=this.parseNodeAttr(o),i=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,r):n in i?("PoseNode"===n?i.PoseNode.push(r):void 0!==i[n].id&&(i[n]={},i[n][i[n].id]=i[n]),""!==s.id&&(i[n][s.id]=r)):"number"==typeof s.id?(i[n]={},i[n][s.id]=r):"Properties70"!==n&&(i[n]="PoseNode"===n?[r]:r),"number"==typeof s.id&&(r.id=s.id),""!==s.name&&(r.attrName=s.name),""!==s.type&&(r.attrType=s.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",o="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),o=e[2]),{id:t,name:n,type:o}}parseNodeProperty(e,t,n){let o=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===o&&","===r&&(r=n.replace(/"/g,"").replace(/,$/,"").trim());const s=this.getCurrentNode();if("Properties70"!==s.name){if("C"===o){const e=r.split(",").slice(1),t=parseInt(e[0]),n=parseInt(e[1]);let i=r.split(",").slice(3);i=i.map((function(e){return e.trim().replace(/^"/,"")})),o="connections",r=[t,n],function(e,t){for(let n=0,o=e.length,r=t.length;n<r;n++,o++)e[o]=t[n]}(r,i),void 0===s[o]&&(s[o]=[])}"Node"===o&&(s.id=r),o in s&&Array.isArray(s[o])?s[o].push(r):"a"!==o?s[o]=r:s.a=r,this.setCurrentProp(s,o),"a"===o&&","!==r.slice(-1)&&(s.a=A(r))}else this.parseNodeSpecialProperty(e,o,r)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=A(t.a))}parseNodeSpecialProperty(e,t,n){const o=n.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),r=o[0],s=o[1],i=o[2],a=o[3];let l=o[4];switch(s){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=A(l)}this.getPrevNode()[r]={type:s,type2:i,flag:a,value:l},this.setCurrentProp(this.getPrevNode(),r)}}class m{parse(e){const t=new f(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const o=new g;for(;!this.endOfContent(t);){const e=this.parseNode(t,n);null!==e&&o.add(e.name,e)}return o}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},o=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const s=e.getUint8(),i=e.getString(s);if(0===o)return null;const a=[];for(let t=0;t<r;t++)a.push(this.parseProperty(e));const l=a.length>0?a[0]:"",c=a.length>1?a[1]:"",u=a.length>2?a[2]:"";for(n.singleProperty=1===r&&e.getOffset()===o;o>e.getOffset();){const o=this.parseNode(e,t);null!==o&&this.parseSubNode(i,n,o)}return n.propertyList=a,"number"==typeof l&&(n.id=l),""!==c&&(n.attrName=c),""!==u&&(n.attrType=u),""!==i&&(n.name=i),n}parseSubNode(e,t,n){if(!0===n.singleProperty){const e=n.propertyList[0];Array.isArray(e)?(t[n.name]=n,n.a=e):t[n.name]=e}else if("Connections"===e&&"C"===n.name){const e=[];n.propertyList.forEach((function(t,n){0!==n&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===n.name){Object.keys(n).forEach((function(e){t[e]=n[e]}))}else if("Properties70"===e&&"P"===n.name){let e=n.propertyList[0],o=n.propertyList[1];const r=n.propertyList[2],s=n.propertyList[3];let i;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===o.indexOf("Lcl ")&&(o=o.replace("Lcl ","Lcl_")),i="Color"===o||"ColorRGB"===o||"Vector"===o||"Vector3D"===o||0===o.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[e]={type:o,type2:r,flag:s,value:i}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const o=e.getUint32(),s=e.getUint32(),i=e.getUint32();if(0===s)switch(t){case"b":case"c":return e.getBooleanArray(o);case"d":return e.getFloat64Array(o);case"f":return e.getFloat32Array(o);case"i":return e.getInt32Array(o);case"l":return e.getInt64Array(o)}const a=r.HT(new Uint8Array(e.getArrayBuffer(i))),l=new f(a.buffer);switch(t){case"b":case"c":return l.getBooleanArray(o);case"d":return l.getFloat64Array(o);case"f":return l.getFloat32Array(o);case"i":return l.getInt32Array(o);case"l":return l.getInt64Array(o)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class f{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let n=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const o=n.indexOf(0);return o>=0&&(n=new Uint8Array(this.dv.buffer,t,o)),this._textDecoder.decode(n)}}class g{add(e,t){this[e]=t}}function y(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function v(e){return e/46186158e3}const w=[];function I(e,t,n,o){let r;switch(o.mappingType){case"ByPolygonVertex":r=e;break;case"ByPolygon":r=t;break;case"ByVertice":r=n;break;case"AllSame":r=o.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+o.mappingType)}"IndexToDirect"===o.referenceType&&(r=o.indices[r]);const s=r*o.dataSize,i=s+o.dataSize;return function(e,t,n,o){for(let r=n,s=0;r<o;r++,s++)e[s]=t[r];return e}(w,o.buffer,s,i)}const x=new o.USm,b=new o.Pa4;function T(e){const t=new o.yGw,n=new o.yGw,r=new o.yGw,s=new o.yGw,i=new o.yGw,a=new o.yGw,l=new o.yGw,c=new o.yGw,u=new o.yGw,p=new o.yGw,d=new o.yGw,h=new o.yGw,m=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(b.fromArray(e.translation)),e.preRotation){const t=e.preRotation.map(o.M8C.degToRad);t.push(e.eulerOrder||o.USm.DEFAULT_ORDER),n.makeRotationFromEuler(x.fromArray(t))}if(e.rotation){const t=e.rotation.map(o.M8C.degToRad);t.push(e.eulerOrder||o.USm.DEFAULT_ORDER),r.makeRotationFromEuler(x.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(o.M8C.degToRad);t.push(e.eulerOrder||o.USm.DEFAULT_ORDER),s.makeRotationFromEuler(x.fromArray(t)),s.invert()}e.scale&&i.scale(b.fromArray(e.scale)),e.scalingOffset&&l.setPosition(b.fromArray(e.scalingOffset)),e.scalingPivot&&a.setPosition(b.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(b.fromArray(e.rotationOffset)),e.rotationPivot&&u.setPosition(b.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(d.copy(e.parentMatrix),p.copy(e.parentMatrixWorld));const f=n.clone().multiply(r).multiply(s),g=new o.yGw;g.extractRotation(p);const y=new o.yGw;y.copyPosition(p);const v=y.clone().invert().multiply(p),w=g.clone().invert().multiply(v),I=i,T=new o.yGw;if(0===m)T.copy(g).multiply(f).multiply(w).multiply(I);else if(1===m)T.copy(g).multiply(w).multiply(f).multiply(I);else{const e=(new o.yGw).scale((new o.Pa4).setFromMatrixScale(d)).clone().invert(),t=w.clone().multiply(e);T.copy(g).multiply(f).multiply(t).multiply(I)}const S=u.clone().invert(),A=a.clone().invert();let L=t.clone().multiply(c).multiply(u).multiply(n).multiply(r).multiply(s).multiply(S).multiply(l).multiply(a).multiply(i).multiply(A);const P=(new o.yGw).copyPosition(L),E=p.clone().multiply(P);return h.copyPosition(E),L=h.clone().multiply(T),L.premultiply(p.invert()),L}function S(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function A(e){return e.split(",").map((function(e){return parseFloat(e)}))}function L(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,n))}function P(e,t,n){return e.slice(0,t).concat(n).concat(e.slice(t))}}}]);